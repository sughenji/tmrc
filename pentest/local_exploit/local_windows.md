# Local exploit Windows

- [Local enumeration](#local-enumeration)
- [Automated tools](#automated-tools)
	- [WinPEAS](#winpeas)
- [Kernel exploit](#kernel-exploit)
- [Linux Subsystem for Windows](#linux-subsystem-for-windows)
- [Token impersonation](#token-impersonation)
- [getsystem](#getsystem)
- [runAs](#runas)
- [autorun](#autorun)
- [alwaysinstalledelevated](#alwaysinstalledelevated)
- [Service escalation](#service-escalation)
- [Executable files](#executable-files)
- [Startup Applications](#startup-applications)
- [DLL hijacking](#dll-hijacking)
- [Service Permissions and path](#service-permissions-and-path)
- [Unquoted service path](#unquoted-service-path)
- [CVE-2019-1388](#cve-2019-1388)
- [RoguePotato](#rogue-potato)

## Local enumeration

### hostname

```
C:\Users\sugo>hostname
GRAVITY

C:\Users\sugo>
```

### systeminfo

```
c:\windows\system32\inetsrv>systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
OS Name:                   Microsoft Windows 7 Enterprise
OS Version:                6.1.7600 N/A Build 7600
System Type:               X86-based PC
```

```
c:\windows\system32\inetsrv>systeminfo
systeminfo

Host Name:                 DEVEL
OS Name:                   Microsoft Windows 7 Enterprise
OS Version:                6.1.7600 N/A Build 7600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          babis
Registered Organization:
Product ID:                55041-051-0948536-86302
Original Install Date:     17/3/2017, 4:17:31 
System Boot Time:          3/4/2021, 11:58:17 
System Manufacturer:       VMware, Inc.
System Model:              VMware Virtual Platform
System Type:               X86-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: x64 Family 23 Model 1 Stepping 2 AuthenticAMD ~2000 Mhz
BIOS Version:              Phoenix Technologies LTD 6.00, 12/12/2018
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             el;Greek
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC+02:00) Athens, Bucharest, Istanbul
Total Physical Memory:     3.071 MB
Available Physical Memory: 2.477 MB
Virtual Memory: Max Size:  6.141 MB
Virtual Memory: Available: 5.556 MB
Virtual Memory: In Use:    585 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    HTB
Logon Server:              N/A
Hotfix(s):                 N/A
Network Card(s):           1 NIC(s) Installed.
                           [01]: vmxnet3 Ethernet Adapter
                                 Connection Name: Local Area Connection 3
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 10.10.10.5
                                 [02]: fe80::58c0:f1cf:abc6:bb9e
                                 [03]: dead:beef::28be:c7e1:1cec:59a5
                                 [04]: dead:beef::58c0:f1cf:abc6:bb9e
```

### Windows Management Instrumentation (WMI)

```
wmic qfe get Caption,Description,HotFixID,InstalledON


C:\Users\sugo>wmic qfe get Caption,Description,HotFixID,InstalledON
Caption                                     Description      HotFixID   InstalledOn
http://support.microsoft.com/?kbid=4601056  Update           KB4601056  2/11/2021
http://support.microsoft.com/?kbid=4513661  Update           KB4513661  1/9/2020
http://support.microsoft.com/?kbid=4516115  Security Update  KB4516115  1/9/2020
http://support.microsoft.com/?kbid=4517245  Update           KB4517245  1/9/2020
http://support.microsoft.com/?kbid=4528759  Security Update  KB4528759  1/9/2020
http://support.microsoft.com/?kbid=4535680  Security Update  KB4535680  1/15/2021
http://support.microsoft.com/?kbid=4537759  Security Update  KB4537759  3/25/2020
http://support.microsoft.com/?kbid=4541338  Security Update  KB4541338  3/24/2020
http://support.microsoft.com/?kbid=4552152  Security Update  KB4552152  4/15/2020
http://support.microsoft.com/?kbid=4559309  Update           KB4559309  7/6/2020
http://support.microsoft.com/?kbid=4560959  Security Update  KB4560959  6/10/2020
http://support.microsoft.com/?kbid=4561600  Security Update  KB4561600  6/10/2020
http://support.microsoft.com/?kbid=4565554  Security Update  KB4565554  7/15/2020
http://support.microsoft.com/?kbid=4569073  Security Update  KB4569073  8/12/2020
https://support.microsoft.com/help/4576751  Security Update  KB4576751  9/8/2020
https://support.microsoft.com/help/4577670  Security Update  KB4577670  10/14/2020
https://support.microsoft.com/help/4580325  Security Update  KB4580325  10/14/2020
https://support.microsoft.com/help/4586863  Security Update  KB4586863  11/11/2020
https://support.microsoft.com/help/4598479  Security Update  KB4598479  1/14/2021
https://support.microsoft.com/help/4601395  Security Update  KB4601395  2/11/2021
https://support.microsoft.com/help/5000908  Security Update  KB5000908  3/11/2021
https://support.microsoft.com/help/5000808  Security Update  KB5000808  3/11/2021
```

```
c:\windows\system32\inetsrv>wmic qfe
C:\Users\sugo>wmic qfe
Caption                                     CSName   Description      FixComments  HotFixID   InstallDate  InstalledBy          InstalledOn  Name  ServicePackInEffect  Status
http://support.microsoft.com/?kbid=4601056  GRAVITY  Update                        KB4601056               NT AUTHORITY\SYSTEM  2/11/2021
http://support.microsoft.com/?kbid=4513661  GRAVITY  Update                        KB4513661                                    1/9/2020
http://support.microsoft.com/?kbid=4516115  GRAVITY  Security Update               KB4516115                                    1/9/2020
http://support.microsoft.com/?kbid=4517245  GRAVITY  Update                        KB4517245                                    1/9/2020
http://support.microsoft.com/?kbid=4528759  GRAVITY  Security Update               KB4528759                                    1/9/2020
http://support.microsoft.com/?kbid=4535680  GRAVITY  Security Update               KB4535680               NT AUTHORITY\SYSTEM  1/15/2021
http://support.microsoft.com/?kbid=4537759  GRAVITY  Security Update               KB4537759               NT AUTHORITY\SYSTEM  3/25/2020
http://support.microsoft.com/?kbid=4541338  GRAVITY  Security Update               KB4541338               NT AUTHORITY\SYSTEM  3/24/2020
http://support.microsoft.com/?kbid=4552152  GRAVITY  Security Update               KB4552152               NT AUTHORITY\SYSTEM  4/15/2020
http://support.microsoft.com/?kbid=4559309  GRAVITY  Update                        KB4559309               NT AUTHORITY\SYSTEM  7/6/2020
http://support.microsoft.com/?kbid=4560959  GRAVITY  Security Update               KB4560959               NT AUTHORITY\SYSTEM  6/10/2020
http://support.microsoft.com/?kbid=4561600  GRAVITY  Security Update               KB4561600               NT AUTHORITY\SYSTEM  6/10/2020
http://support.microsoft.com/?kbid=4565554  GRAVITY  Security Update               KB4565554               NT AUTHORITY\SYSTEM  7/15/2020
http://support.microsoft.com/?kbid=4569073  GRAVITY  Security Update               KB4569073               NT AUTHORITY\SYSTEM  8/12/2020
https://support.microsoft.com/help/4576751  GRAVITY  Security Update               KB4576751               NT AUTHORITY\SYSTEM  9/8/2020
https://support.microsoft.com/help/4577670  GRAVITY  Security Update               KB4577670               NT AUTHORITY\SYSTEM  10/14/2020
https://support.microsoft.com/help/4580325  GRAVITY  Security Update               KB4580325               NT AUTHORITY\SYSTEM  10/14/2020
https://support.microsoft.com/help/4586863  GRAVITY  Security Update               KB4586863               NT AUTHORITY\SYSTEM  11/11/2020
https://support.microsoft.com/help/4598479  GRAVITY  Security Update               KB4598479               NT AUTHORITY\SYSTEM  1/14/2021
https://support.microsoft.com/help/4601395  GRAVITY  Security Update               KB4601395               NT AUTHORITY\SYSTEM  2/11/2021
https://support.microsoft.com/help/5000908  GRAVITY  Security Update               KB5000908               NT AUTHORITY\SYSTEM  3/11/2021
https://support.microsoft.com/help/5000808  GRAVITY  Security Update               KB5000808               NT AUTHORITY\SYSTEM  3/11/2021
```

### List installed software

```
C:\WINDOWS\system32>wmic
wmic:root\cli>/output:c:\installed_programs.txt product get name,version
wmic:root\cli>

C:\Windows\system32>wmic product get name,version
Name                                        Version
Kaspersky Security Center 10 Network Agent  10.3.407
Microsoft Update Health Tools               2.81.0.0
Kaspersky Endpoint Security for Windows     11.5.0.590
Python 2.7.1                                2.7.1150
```

### Local disks

```
c:\windows\system32\inetsrv>wmic logicaldisk get caption,description,providername
wmic logicaldisk get caption,description,providername
Caption  Description              ProviderName
A:       3 1/2 Inch Floppy Drive
C:       Local Fixed Disk
```

### User enumeration

```
c:\windows\system32\inetsrv>whoami
whoami
iis apppool\web



c:\windows\system32\inetsrv>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeShutdownPrivilege           Shut down the system                      Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeUndockPrivilege             Remove computer from docking station      Disabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
SeTimeZonePrivilege           Change the time zone                      Disabled




c:\windows\system32\inetsrv>whoami /groups
whoami /groups

GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes
==================================== ================ ============ ==================================================
Mandatory Label\High Mandatory Level Label            S-1-16-12288
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
BUILTIN\IIS_IUSRS                    Alias            S-1-5-32-568 Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
                                     Unknown SID type S-1-5-82-0   Mandatory group, Enabled by default, Enabled group




c:\windows\system32\inetsrv>net user
net user

User accounts for \\

-------------------------------------------------------------------------------
Administrator            babis                    Guest
The command completed with one or more errors.







c:\windows\system32\inetsrv>net user babis
net user babis
User name                    babis
Full Name
Comment
User's comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            18/3/2017 2:15:19 ▒▒
Password expires             Never
Password changeable          18/3/2017 2:15:19 ▒▒
Password required            No
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   18/3/2017 2:17:50 ▒▒

Logon hours allowed          All

Local Group Memberships      *Users
Global Group memberships     *None
The command completed successfully.





c:\windows\system32\inetsrv>net localgroup administrators
net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
The command completed successfully.
```	

### Network connections

```
c:\windows\system32\inetsrv>netstat -ano
netstat -ano

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:21             0.0.0.0:0              LISTENING       1416
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       708
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:5357           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:49152          0.0.0.0:0              LISTENING       412
  TCP    0.0.0.0:49153          0.0.0.0:0              LISTENING       772
  TCP    0.0.0.0:49154          0.0.0.0:0              LISTENING       892
  TCP    0.0.0.0:49155          0.0.0.0:0              LISTENING       512
  TCP    0.0.0.0:49156          0.0.0.0:0              LISTENING       528
  TCP    10.10.10.5:139         0.0.0.0:0              LISTENING       4
  TCP    10.10.10.5:49160       10.10.14.7:4444        ESTABLISHED     1476
  TCP    [::]:21                [::]:0                 LISTENING       1416
  TCP    [::]:80                [::]:0                 LISTENING       4
  TCP    [::]:135               [::]:0                 LISTENING       708
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:5357              [::]:0                 LISTENING       4
  TCP    [::]:49152             [::]:0                 LISTENING       412
```

### Passwords

```
c:\Windows\System32>findstr /si password *.txt *.ini *.config
findstr /si password *.txt *.ini *.config
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password."
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password.";
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          >> Msg1="Please enter your password.";
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1                    Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1                           Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1                           Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password."
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:        Msg1                           "Please enter your password."
WindowsPowerShell\v1.0\en-US\about_remote_FAQ.help.txt:    name and password credentials on the local computer or the credentials
WindowsPowerShell\v1.0\en-US\about_remote_troubleshooting.help.txt:    2. Verify that a password is set on the workgroup-based computer. If a
WindowsPowerShell\v1.0\en-US\about_remote_troubleshooting.help.txt:       password is not set or the password value is empty, you cannot run
WindowsPowerShell\v1.0\en-US\about_remote_troubleshooting.help.txt:       To set password for your user account, use User Accounts in Control
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:          function ScreenPassword($instance)
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:          foreach ($a in @(get-wmiobject win32_desktop)) { ScreenPassword($a) }
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:      This script checks each user account. The ScreenPassword function returns
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:      the name of any user account that does not have a password-protected
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:      screen saver. If the screen saver is password protected, the function
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    The MakeCert.exe tool will prompt you for a private key password. The
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    password ensures that no one can use or access the certificate without
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    your consent. Create and enter a password that you can remember. You will
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    use this password later to retrieve the certificate.
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:        6. Type a password, and then type it again to confirm.
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:        4. On the Password page, select "Enable strong private key protection",
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:           and then enter the password that you assigned during the export
FINDSTR: Cannot open restore\MachineGuid.txt
```

See also:

https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html

### Local files to grab

```
%SYSTEMDRIVE%\boot.ini
%WINDIR%\win.ini
%SYSTEMROOT%\repair\SAM
%SYSTEMROOT%\System32\config\RegBack\SAM
%SYSTEMROOT%\repair\SYSTEM
%SYSTEMROOT%\System32\config\RegBack\SYSTEM

%SYSTEMDRIVE%\pagefile.sys
%WINDIR%\debug\NetSetup.log
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software
%WINDIR%\repair\security

%WINDIR%\system32\config\AppEvent.Evt
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav
```

See also:

https://msrc-blog.microsoft.com/2014/05/13/ms14-025-an-update-for-group-policy-preferences/

### Stored credentials

```
PS C:\Users\security> cmdkey /list

Currently stored credentials:

    Target: Domain:interactive=ACCESS\Administrator
    Type: Domain Password
    User: ACCESS\Administrator
```

### Wifi Password

```
netsh wlan show profile <SSID> key=clear
```

### Antivirus software

```
c:\Windows\System32>sc query windefend
sc query windefend

SERVICE_NAME: windefend
        TYPE               : 20  WIN32_SHARE_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0





c:\windows\system32\inetsrv>sc queryex type= service
sc queryex type= service

SERVICE_NAME: AppHostSvc
DISPLAY_NAME: Application Host Helper Service
        TYPE               : 20  WIN32_SHARE_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 1332
        FLAGS              :
```

### Firewall

```
c:\windows\system32\inetsrv>netsh advfirewall firewall dump



c:\windows\system32\inetsrv>netsh firewall show state
netsh firewall show state

Firewall status:
-------------------------------------------------------------------
Profile                           = Standard
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable
Group policy version              = Windows Firewall
Remote admin mode                 = Disable

Ports currently open on all network interfaces:
Port   Protocol  Version  Program
-------------------------------------------------------------------
No ports are currently open on all network interfaces.



c:\windows\system32\inetsrv>netsh firewall show config
netsh firewall show config

Domain profile configuration:
-------------------------------------------------------------------
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable

Allowed programs configuration for Domain profile:
Mode     Traffic direction    Name / Program
-------------------------------------------------------------------

Port configuration for Domain profile:
Port   Protocol  Mode    Traffic direction     Name
-------------------------------------------------------------------

ICMP configuration for Domain profile:
Mode     Type  Description
-------------------------------------------------------------------
Enable   2     Allow outbound packet too big

Standard profile configuration (current):
-------------------------------------------------------------------
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable

Service configuration for Standard profile:
Mode     Customized  Name
-------------------------------------------------------------------
Enable   No          File and Printer Sharing
Enable   No          Network Discovery

Allowed programs configuration for Standard profile:
Mode     Traffic direction    Name / Program
-------------------------------------------------------------------

Port configuration for Standard profile:
Port   Protocol  Mode    Traffic direction     Name
-------------------------------------------------------------------

ICMP configuration for Standard profile:
Mode     Type  Description
-------------------------------------------------------------------
Enable   2     Allow outbound packet too big

Log configuration:
-------------------------------------------------------------------
File location   = C:\Windows\system32\LogFiles\Firewall\pfirewall.log
Max file size   = 4096 KB
Dropped packets = Disable
Connections     = Disable

IMPORTANT: Command executed successfully.
However, "netsh firewall" is deprecated;
use "netsh advfirewall firewall" instead.
For more information on using "netsh advfirewall firewall" commands
instead of "netsh firewall", see KB article 947709
at http://go.microsoft.com/fwlink/?linkid=121488 .
```

## Automated Tools

### WinPEAS

https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS

### Windows Privesc check list

https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation

### Sherlock

https://github.com/rasta-mouse/Sherlock

```
C:\Users\kostas\Desktop>powershell.exe -ExecutionPolicy Bypass -command "& {Import-Module .\sherlock.ps1; Find-AllVulns}"
```

```
Title      : Secondary Logon Handle
MSBulletin : MS16-032
CVEID      : 2016-0099
Link       : https://www.exploit-db.com/exploits/39719/
VulnStatus : Appears Vulnerable
```

### Watson

https://github.com/rasta-mouse/Watson

### PowerUp

https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

### JAWS

https://github.com/411Hall/JAWS

### Windows-Exploit-Suggester

https://github.com/AonCyberLabs/Windows-Exploit-Suggester

https://raw.githubusercontent.com/AonCyberLabs/Windows-Exploit-Suggester/master/windows-exploit-suggester.py

first step to run:

```
./windows-exploit-suggester.py  --update
[*] initiating winsploit version 3.3...
[+] writing to file 2020-09-22-mssb.xls
[*] done
```

grab systeminfo (just after the line "systeminfo") and then run:

```
./windows-exploit-suggester.py --database 2020-09-22-mssb.xls --systeminfo nomehost-sysinfo.txt
```

### Metasploit local exploit suggester
