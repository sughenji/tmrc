#malware #malware-traffic-analysis #wireshark

https://www.malware-traffic-analysis.net/2017/01/28/index.html

User made a Bing search for "home improvement remodeling your kitchen" (`tcp.stream==38`) and reach domain `www.homeimprovement.com` which looks like a Wordpress site:

```http
GET /remodeling-your-kitchen-cabinets.html HTTP/1.1
Accept: text/html, application/xhtml+xml, */*
Referer: http://www.bing.com/search?q=home+improvement+remodeling+your+kitchen&qs=n&sp=-1&pq=home+improvement+remodeling+your+kitchen&sc=0-40&sk=&cvid=194EC908DA65455B9E9A98285A33132B&first=7&FORM=PERE
Accept-Language: en-US
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko
Accept-Encoding: gzip, deflate
Host: www.homeimprovement.com
Connection: Keep-Alive
  

HTTP/1.1 200 OK
Date: Fri, 27 Jan 2017 22:54:42 GMT
Content-Type: text/html; charset=UTF-8
Transfer-Encoding: chunked
Connection: keep-alive
Set-Cookie: __cfduid=d71ccd28c86be89b01677d353cf24ee741485557681; expires=Sat, 27-Jan-18 22:54:41 GMT; path=/; domain=.homeimprovement.com; HttpOnly
X-Powered-By: PHP/5.5.9-1ubuntu4.14
Set-Cookie: PHPSESSID=29rqt67qj95ph1amhahrtnhd54; path=/
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
X-Pingback: http://www.homeimprovement.com/xmlrpc.php
Link: <http://www.homeimprovement.com/wp-json/>; rel="https://api.w.org/"
Link: <http://www.homeimprovement.com/?p=199>; rel=shortlink
Vary: Accept-Encoding, Cookie
Server: cloudflare-nginx
CF-RAY: 327fc9b56646186a-EWR
Content-Encoding: gzip
```

## stream 43

suspicious Javascript (`/engine/classes/js/dle_js.js`) on host: `retrotip.visionurbana.com.ve`

```http
GET /engine/classes/js/dle_js.js HTTP/1.1
Accept: application/javascript, */*;q=0.8
Referer: http://www.homeimprovement.com/remodeling-your-kitchen-cabinets.html
Accept-Language: en-US
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko
Accept-Encoding: gzip, deflate
Host: retrotip.visionurbana.com.ve
Connection: Keep-Alive
```

iframe to `tyu.benme.com`

![](_attachment/Pasted%20image%2020250118154420.png)

if we look at exported objects, we found three Adobe Flash:

```bash
$ file * |grep -i flash
%3fbiw=Amaya.126qv100.406m1g9g5&ct=Amaya&tuif=2927&q=zn3QMvXcJwDQDoTGMvrESLtEMU_QA0KK2OH_76qyEoH9JHT1vrTUSkrttgWCelr&oq=X_fUlL7ABPAay2EyALQZnlY0IU1IQ8fj630PWwUWZ0pDRqxS9ZQxD_JGlV7V8jg&yus=Amaya.83fn61.406z8s0i4&br_fl=4442:                                   Macromedia Flash data (compressed), version 31
%3fbiw=SeaMonkey.105qj67.406x7d8b3&yus=SeaMonkey.78vg115.406g6d1r6&br_fl=2957&oq=pLLYGOAq3jxbTfgFplIgIUVlCpaqq3UbTykKZhJKB9BSKaA9E-qKSErM62V7FjLhTJg&q=w3rQMvXcJx7QFYbGMvjDSKNbNkfWHViPxoaG9MildZqqZGX_k7fDfF-qoVzcCgWRxfs&ct=SeaMonkey&tuif=1166:               Macromedia Flash data (compressed), version 31
%3ftuif=2138&br_fl=1788&oq=_skK7pSP1LghRbVcgU3n4lbWw8S_6qniBCBmBWUgcSHrxLeNw51_paUErQ66B6ymQ&q=wHvQMvXcJwDGFYbGMvrETqNbNknQA0GPxpH2_drRdZqxKGni0eb5UUSk6F2CEh3h8&ct=Vivaldi&biw=Vivaldi.101ck66.406l4u7k3&yus=Vivaldi.105zs88.406b4o1l4:                         Macromedia Flash data (compressed), version 31
```

if we compare MD5 checksum, we can conclude that the files are the same.

`f858070326067ba282d2a63969868e5a`

https://www.virustotal.com/gui/file/b3669ec83fb4bba5257da8c68b32dc15d1a08e9e8c22c7483698f29de2839b5f

![](_attachment/Pasted%20image%2020250119181649.png)



## stream 45

we look for frames containing string "Vivaldi" (as the file name of .swf files) and we found this stream.

![](_attachment/Pasted%20image%2020250119182016.png)

obfuscated javascript code:

![](_attachment/Pasted%20image%2020250119182300.png)

Download of Flash file from host `tyu.benme.com`

![](_attachment/Pasted%20image%2020250119182450.png)

## stream 53

strange div with on host `spotsbill.com`

![](_attachment/Pasted%20image%2020250119182740.png)
## stream 54

stuff related to Bitcon (ransomware compromission?)

```http
GET /v1/btc/main/addrs/17gd1msp5FnMcEMF1MitTNSsYs7w7AQyCt?_=1485557725120 HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; WOW64; Trident/7.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0)
Host: api.blockcypher.com
Connection: Keep-Alive


HTTP/1.1 200 OK
Server: nginx/1.11.9
Date: Fri, 27 Jan 2017 22:55:27 GMT
Content-Type: application/json
Transfer-Encoding: chunked
Connection: keep-alive
Access-Control-Allow-Headers: Origin, X-Requested-With, Content-Type, Accept
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Origin: *
X-Ratelimit-Remaining: 99
Content-Encoding: gzip


{
"address": "17gd1msp5FnMcEMF1MitTNSsYs7w7AQyCt",
"total_received": 6154731106,
"total_sent": 6118716106,
"balance": 36015000,
"unconfirmed_balance": 0,
"final_balance": 36015000,
"n_tx": 273,
"unconfirmed_n_tx": 0,
"final_n_tx": 273,
"txrefs": [
{
"tx_hash": "c569de621b18f626c71e102dd68f022de822feefd607f5c2bc321a99f3623201",
..
..
```

## answers

The infected workstation is: `STEWIE-PC`, ip: `172.16.4.193`, mac address: `5c:26:0a:02:a8:e4`

The initial search was for "home improvement remodeling your kitchen" on Bing site.

The website `www.homeimprovement.com` (cms: Wordpress) results infected, as we notice a connection to resource `/engine/classes/js/dle_js.js` on host `retrotip.visionurbana.com.ve` which also contains an iframe to host `tyu.benme.com`

The user downloaded a Flash malicious file (`f858070326067ba282d2a63969868e5a`) which probably led to a ransomware compromission 

## snort

We download subscription rules with our *oinkcode*

```bash
https://www.snort.org/rules/snortrules-snapshot-3000.tar.gz?oinkcode=ab7100531c1axxxxxxxxxxxxx
```

```bash
joshua@kaligra:~/Documents$ docker cp  snortrules-snapshot-3000.tar.gz 3ecf9817245d:/snortrules-snapshot-3000.tar.gz
joshua@kaligra:~/Documents$
```

