# Malware Analysis

- [Tools](#tools)
	- [Oledump](#oledump)
		- [Dump streams](#dump-streams)
		- [Analyze stream](#analyze-stream)
		- [Print metadata](#print-metadata)
		- [Plugin biff](#plugin-biff)
- [Online resources](#online-resources)
- [General infos](#general-infos)
- [Truestory Analysis](#truestory-analysis)
- [Virustotal](#virustotal)
- [Malware samples](#malware-samples)

## tools

regshot https://sourceforge.net/projects/regshot/

Sysinternals: Process Monitor and Process Explorer

Fake DNS: https://www.fireeye.com/services/freeware/apatedns.html

Sandbox: https://cuckoosandbox.org/

Browserling: https://www.browserling.com/

Wannabrowser: https://www.wannabrowser.net/

Floss: https://github.com/mandiant/flare-floss (to extract strings)

CAPA: https://github.com/mandiant/capa

## oledump

reference:

https://www.youtube.com/watch?v=kk1KUEVtDgQ&list=PLa-ohdLO29_bPkYHC3bBUM5jh1vwrmzqX

```
$ hexdump -C -v ex001.doc  |head
00000000  d0 cf 11 e0 a1 b1 1a e1  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  3e 00 03 00 fe ff 09 00  |........>.......|
00000020  06 00 00 00 00 00 00 00  00 00 00 00 01 00 00 00  |................|
00000030  26 00 00 00 00 00 00 00  00 10 00 00 28 00 00 00  |&...........(...|
```

`D0 CF 11 E0` magic bytes for *Compound File Binary Format*

### dump streams

To dump every "streams" inside the file:

```
$ python2 ./oledump.py exercises/ex001.doc
  1:       114 '\x01CompObj'
  2:      4096 '\x05DocumentSummaryInformation'
  3:      4096 '\x05SummaryInformation'
  4:      6360 '1Table'
  5:      4096 'WordDocument'
```

### analyze stream

To analyze first stream:

```
$ python2 ./oledump.py -s 1 exercises/ex001.doc
00000000: 01 00 FE FF 03 0A 00 00 FF FF FF FF 06 09 02 00  ..▒▒....▒▒▒▒....
00000010: 00 00 00 00 C0 00 00 00 00 00 00 46 20 00 00 00  ....▒......F ...
00000020: 4D 69 63 72 6F 73 6F 66 74 20 57 6F 72 64 20 39  Microsoft Word 9
00000030: 37 2D 32 30 30 33 20 44 6F 63 75 6D 65 6E 74 00  7-2003 Document.
00000040: 0A 00 00 00 4D 53 57 6F 72 64 44 6F 63 00 10 00  ....MSWordDoc...
..
..
```

`-x` to just show HEX

`-d` to dump bytes in raw format

### print metadata

To print metadata:

```
$ python2 ./oledump.py -M exercises/ex002.xls
Properties SummaryInformation:
 codepage: 1252 ANSI Latin 1; Western European (Windows)
 author: root
 last_saved_by: root
 create_time: 2015-09-06 09:36:33
 last_saved_time: 2015-09-06 09:36:58
 creating_application: Microsoft Excel
 security: 0
..
..
```

### plugin biff

```
$ python2 ./oledump.py -p plugin_biff exercises/ex002.xls
  1:      4096 '\x05DocumentSummaryInformation'
  2:      4096 '\x05SummaryInformation'
  3:     13235 'Workbook'
               Plugin: BIFF plugin
                 0809     16 BOF : Beginning of File
                 00e1      2 INTERFACEHDR : Beginning of User Interface Records
                 00c1      2 MMS :  ADDMENU / DELMENU Record Group Count
                 00e2      0 INTERFACEEND : End of User Interface Records
..
..
```


## online resources

https://any.run/

https://www.hybrid-analysis.com/

https://abuse.ch/ and his sub-domains:

https://bazaar.abuse.ch/

you can upload a sample or research (eg. `md5:367b6a5c0e0e8ec68ea14a085b1d32b3`)

https://threatfox.abuse.ch

eg. search for `ioc:212.192.246.30:5555`

https://sslbl.abuse.ch/

https://urlhaus.abuse.ch

https://urlscan.io/

https://sitecheck.sucuri.net/

https://www.urlvoid.com

https://feodotracker.abuse.ch

https://feodotracker.abuse.ch/browse.php?search=178.134.47.166

API often used in malware: https://malapi.io/

## General infos

https://any.run/malware-trends/


## Truestory analysis

https://www.microsoft.com/security/blog/2019/07/08/dismantling-a-fileless-campaign-microsoft-defender-atp-next-gen-protection-exposes-astaroth-attack/

## Virustotal

```
joshua@kaligra:~$ msf-virustotal -k 94410b2bd266b6e3d2e859aa278efea7b3684181XXXXXXXXXXXXXXXXXXXXXX -f Documents/malware-traffic-analysis/knr.exe
[*] Using API key: 94410b2bd266b6e3d2e859aa278efea7b3684181XXXXXXXXXXXXXXXXXXXXXXXX
[*] Please wait while I upload Documents/malware-traffic-analysis/knr.exe...
[*] VirusTotal: Scan request successfully queued, come back later for the report
[*] Sample MD5 hash    : cc28e40b46237ab6d5282199ef78c464
[*] Sample SHA1 hash   : 0d5c820002cf93384016bd4a2628dcc5101211f4
[*] Sample SHA256 hash : 749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18
[*] Analysis link: https://www.virustotal.com/gui/file/749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18/detection/f-749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18-1662214988
[*] Requesting the report...
[*] Analysis Report: knr.exe (47 / 71): 749e161661290e8a2d190b1a66469744127bc25bf46e5d0c6f2e835f4b92db18
====================================================================================================

 Antivirus             Detected  Version               Result                                              Update
 ---------             --------  -------               ------                                              ------
 ALYac                 true      1.1.3.1               Backdoor.RAT.Netwire                                20220824
 APEX                  true      6.326                 Malicious                                           20220822
 AVG                   true      21.1.5827.0           Win32:Malware-gen                                   20220824
 Acronis               false     1.2.0.108                                                                 20220426
 Ad-Aware              true      3.0.21.193            Trojan.GenericKD.32089895                           20220824
..
..
..
..
```


## Malware samples

https://github.com/ytisf/theZoo

https://github.com/vxunderground/MalwareSourceCode

https://zeltser.com/malware-sample-sources/
